angular.module("helpNow",["ngRoute","ngResource"]).config(["$routeProvider",function(e){e.when("/ind_login",{templateUrl:"views/ind-login.html"}),e.when("/org_login",{templateUrl:"views/org-login.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.when("/event_map/:eventID",{templateUrl:"views/event-map.html"}),e.when("/gov_login",{templateUrl:"views/gov-login.html"}),e.when("/org_event/:eventID",{templateUrl:"views/org-event.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.otherwise({templateUrl:"views/events.html"})}]),angular.module("helpNow").controller("EventListCtrl",["$scope",function(e){function t(){n&&e.events&&angular.forEach(e.events,function(t){var r=L.icon({iconUrl:e.getIcon(t.EventType.Description),iconSize:[43,44]}),o=L.marker([t.EventLocations[0].LAT,t.EventLocations[0].LONG],{icon:r});o.on("click",function(){window.location="#event_map/"+t.EventID}),o.addTo(n)})}var n;e.setCurrentView("events"),e.$on("EventDataLoaded",function(){t()}),e.initMap=function(e){n=e,t()}}]),angular.module("helpNow").controller("EventMapCtrl",["$scope","$routeParams",function(e,t){e.eventID=1*t.eventID,e.event=e.getEvent(e.eventID),e.resources=e.getResourcesForEvent(e.eventID),e.resource=e.resources[0],e.setCurrentView("event-map"),e.initMap=function(t){t.on("click",function(e){void 0!==locationOutline&&t.removeLayer(locationOutline),locationOutline=L.circle(e.latlng,overlayRadius).addTo(t)});for(var n=L.icon({iconUrl:"style/images/icons/FirstAidResource.png",iconSize:[128,158.25]}),r=L.icon({iconUrl:"style/images/icons/WaterResource.png",iconSize:[72,73]}),o=L.icon({iconUrl:"style/images/icons/EvacuationIcon.png",iconSize:[72,73]}),i=0;i<e.resources.length;i++){var a,s=e.resources[i];"First Aid"==s.resourceType?a=n:"Water"==s.resourceType?a=r:"Evacuation Site"==s.resourceType&&(a=o);var l=L.marker([s.lat,s["long"]],{icon:a}).addTo(t);l.on("click",function(t){for(var n=0;n<e.resources.length;n++){var r=L.latLng(e.resources[n].lat,e.resources[n]["long"]);t.latlng.lat==r.lat&&t.latlng.lng==r.lng&&(e.resource=e.resources[n],e.$apply())}"Evacuation Site"==e.resource.resourceType?showResourcePanel(!1):showResourcePanel(!0)})}}}]),angular.module("helpNow").controller("GovLoginCtrl",["$scope",function(e){e.setCurrentView("govs")}]),angular.module("helpNow").controller("IndLoginCtrl",["$scope",function(e){e.setCurrentView("inds")}]),angular.module("helpNow").controller("OrgEventCtrl",["$scope","$routeParams","$resource",function(e,t,n){function r(e){return"Water"==e?"style/images/marker-blue.png":"First Aid"==e?"style/images/marker-red.png":"Shelter"==e?"style/images/marker-orange.png":"Evacuation"==e?"style/images/marker-purple.png":"Medicine"==e?"style/images/marker-cyan.png":"style/images/marker-green.png"}function o(e){return"Water"==e?"style/images/marker2-blue.png":"First Aid"==e?"style/images/marker2-red.png":"Shelter"==e?"style/images/marker2-orange.png":"Evacuation"==e?"style/images/marker2-purple.png":"Medicine"==e?"style/images/marker2-cyan.png":"style/images/marker2-green.png"}function i(e){return"Water"==e?"style/images/marker-blue-lg.png":"First Aid"==e?"style/images/marker-red-lg.png":"Shelter"==e?"style/images/marker-orange-lg.png":"Evacuation"==e?"style/images/marker-purple-lg.png":"Medicine"==e?"style/images/marker-cyan-lg.png":"style/images/marker-green-lg.png"}function a(e){angular.forEach(e,function(e){var t=L.icon({iconUrl:r(e.ResourceType.Description),iconSize:[27,41]}),n=L.marker([e.LAT,e.LONG],{icon:t});n.bindPopup("<strong>"+e.ResourceType.Description+" ("+e.Quantity+")</strong><br/>"+e.Notes),v.push(n)})}function s(){if(e.requestClusters){var t=e.requestClusters.filter(function(e){var t=e.ResourceType.Description;return u(t)});angular.forEach(t,function(e){var t=L.icon({iconUrl:i(e.ResourceType.Description),iconSize:[40,60]}),n=L.marker([e.LAT,e.LONG],{icon:t});n.bindPopup("<strong>"+e.ResourceType.Description+"</strong><br/>"+e.Notes),v.push(n)})}}function l(e){var t={radius:100,maxOpacity:.5,scaleRadius:!1,useLocalExtrema:!0,latField:"LAT",lngField:"LONG",valueField:"Quantity"},n=new HeatmapOverlay(t),r={data:e};n.setData(r),v.push(n)}function c(){if(e.locations){var t=e.locations.filter(function(e){var t=e.ResourceType.Description;return u(t)});angular.forEach(t,function(e){var t=L.icon({iconUrl:o(e.ResourceType.Description),iconSize:[27,41]}),n=L.marker([e.ResourceLocation.LAT,e.ResourceLocation.LONG],{icon:t});n.bindPopup("<strong>"+e.ResourceType.Description+" ("+e.Organization.Name+")</strong><br/>"+e.Notes),v.push(n)})}}function u(t){return"Water"==t&&e.showWater||"Shelter"==t&&e.showShelter||"Food"==t&&e.showFood||"Evacuation"==t&&e.showEvacuation||"First Aid"==t&&e.showMedical||"Medicine"==t&&e.showMedicine}function g(){if(m&&e.events){for(var t=0;t<v.length;t++){var n=v[t];m.removeLayer(n)}v=[];var r=e.requests.filter(function(e){var t=e.ResourceType.Description;return u(t)});e.showHeatmap&&l(r),e.showNeedsMarkers&&a(r),e.showClusters&&s(),e.showLocationMarkers&&c(),angular.forEach(v,function(e){m.addLayer(e)})}}function p(){e.requestsResource.get({eventID:e.eventID},function(t){e.requests=t.json.requests,e.locations=t.json.locations,e.requestClusters=t.json.requestClusters,g()})}var m,v=[];e.setCurrentView("org-events"),e.requestsResource=n("/api/event/mapitems/:eventID"),e.eventID=1*t.eventID,e.events&&(e.event=e.getEvent(e.eventID),p()),e.requests=[],e.showFilters=!0,e.showMedical=!0,e.showShelter=!0,e.showFood=!0,e.showWater=!0,e.showEvacuation=!0,e.showMedicine=!0,e.showHeatmap=!1,e.showClusters=!1,e.showNeedsMarkers=!0,e.showLocationMarkers=!1,e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),p(),g()}),e.toggleButtonClass=function(t){var n=e[t];return n?"btn btn-toggle active":"btn btn-toggle"},e.toggleButton=function(t){return e[t]=!e[t],g(),!1},e.initMap=function(e){m=e,g()},e.filterButtonClass=function(){return e.showFilters?"glyphicon glyphicon-eye-close":"glyphicon glyphicon-eye-open"},e.filterButtonText=function(){return e.showFilters?"Hide":"Show"},e.toggleFilters=function(){return e.showFilters=!e.showFilters,!1},e.setCurrentView("org-event")}]),angular.module("helpNow").controller("OrgLoginCtrl",["$scope",function(e){e.setCurrentView("orgs")}]),angular.module("helpNow").controller("RootCtrl",["$scope","$http","$resource",function(e,t,n){var r="Eng",o="";e.eventsResource=n("/api/event"),e.loadEvents=function(){e.eventsResource.get({},function(t){e.events=t.json,e.$broadcast("EventDataLoaded",{})})},e.getIcon=function(e){return"Flood"==e?"style/images/icons/FloodIcon.png":"Tsunami"==e?"style/images/icons/TsunamiIcon.png":"style/images/icons/EarthquakeIcon.png"},e.getGrayIcon=function(e){return"Flood"==e?"style/images/icons/FloodGray.png":"Tsunami"==e?"style/images/icons/TsunamiGray.png":"style/images/icons/EarthquakeGray.png"},e.getMenuClass=function(e){return e==o?"active":""},e.setCurrentView=function(e){o=e},e.setCurrentLanguage=function(n){r=n,"Ben"==n?t.get("i18n/text-BEN.json").success(function(t){e.text=t}).error(function(e){alert(e)}):t.get("i18n/text-ENG.json").success(function(t){e.text=t}).error(function(e){alert(e)})},e.getLanguageClass=function(e){return r==e?"active":""},e.setCurrentLanguage("Eng"),e.getResourcesForEvent=function(t){for(var n=[],r=0;r<e.resources.length;r++){var o=e.resources[r];o.eventID==t&&n.push(o)}return n.length>0?n:{}},e.getEvent=function(t){for(var n=0;n<e.events.length;n++){var r=e.events[n];if(r.EventID==t)return r}return{}},e.loadEvents(),e.resources=[{id:1,eventID:1,resourceType:"First Aid",lat:23.718,"long":90.355,provider:"NGO #1",message:""},{id:2,eventID:1,resourceType:"First Aid",lat:23.719,"long":90.374,provider:"NGO #2",message:""},{id:3,eventID:1,resourceType:"First Aid",lat:23.765,"long":90.398,provider:"NGO #3",message:""},{id:4,eventID:1,resourceType:"Water",lat:23.767,"long":90.41,provider:"NGO #4",message:""},{id:5,eventID:1,resourceType:"Evacuation Site",lat:23.73,"long":90.365,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."},{id:6,eventID:1,resourceType:"Evacuation Site",lat:23.75,"long":90.43,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."}]}]),angular.module("helpNow").directive("map",function(){return{link:function(e,t,n){var r=n.mapCenter.split(","),o=n.mapZoom,i="pk.eyJ1IjoiZGlnaXRhbGdsb2JlIiwiYSI6ImNpZjc5N3NiMTA5OXlzb2x6c3FyZHQ3cTUifQ.88yZYJc78Z2MAnkX2fOjuw",a='Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery ï¿½ <a href="http://mapbox.com">Mapbox</a>',s="https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ",l=(L.tileLayer(s,{id:"mapbox.light",attribution:a}),L.tileLayer(s,{id:"mapbox.streets",attribution:a})),c=L.esri.tiledMapLayer({url:"https://services.digitalglobe.com/earthservice/gis/0688362c-8f94-4016-95c3-172c2ab72023/rest/services/DigitalGlobe:ImageryTileService/MapServer",attribution:"DigitalGlobe Basemap, 2015"}),u=(L.tileLayer.wms("https://services.digitalglobe.com/mapservice/wmsaccess?connectid=0688362c-8f94-4016-95c3-172c2ab72023",{layers:"DigitalGlobe:Imagery",format:"image/png",transparent:!0,attribution:"DigitalGlobe 2015"}),L.esri.tiledMapLayer({url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",attribution:"Esri 2015"})),g=new L.tileLayer("https://{s}.tiles.mapbox.com/v4/digitalglobe.n6nhclo2/{z}/{x}/{y}.png?access_token="+i,{minZoom:1,maxZoom:19,attribution:'(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a> , (c) OpenStreetMap, (c) Mapbox'}),p=new L.tileLayer("https://{s}.tiles.mapbox.com/v4/digitalglobe.n6ngnadl/{z}/{x}/{y}.png?access_token="+i,{minZoom:1,maxZoom:19,attribution:'(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a>'}),l=new L.tileLayer("https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token="+i,{minZoom:1,maxZoom:19,attribution:"(c) OpenStreetMap , (c) Mapbox"}),m=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:a,maxZoom:18}),v=new L.map("map",{layers:[m]}).setView(r,o);L.control.scale().addTo(v),v.attributionControl.setPrefix("");var h={"Base Open Street Maps":m,"DigitalGlobe Basemap +Vivid with Streets":g,"DigitalGlobe Basemap +Vivid":p,"Mapbox + OSM Streets":l,"DigitalGlobe Basemap: REST":c,"Esri World Imagery":u};L.control.layers(h,null,{collapsed:!0}).addTo(v),v.addControl(new L.Control.Search({url:"http://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],circleLocation:!1,markerLocation:!1,autoType:!1,autoCollapse:!0,minLength:2,zoom:13})),e.initMap&&e.initMap(v)}}});