angular.module("helpNow",["ngRoute","ngResource"]).config(["$routeProvider",function(e){e.when("/ind_login",{templateUrl:"views/ind-login.html"}),e.when("/org_login",{templateUrl:"views/org-login.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.when("/event_map/:eventID",{templateUrl:"views/event-map.html"}),e.when("/inventory",{templateUrl:"views/inventory.html"}),e.when("/gov_login",{templateUrl:"views/gov-login.html"}),e.when("/org_event/:eventID",{templateUrl:"views/org-event.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.otherwise({templateUrl:"views/events.html"})}]),angular.module("helpNow").controller("EventListCtrl",["$scope","$location",function(e,t){function o(){n&&e.events&&angular.forEach(e.events,function(o){var r=L.icon({iconUrl:e.getMapEventIcon(o.EventType.Description),iconSize:[43,44]}),i=L.marker([o.EventLocations[0].LAT,o.EventLocations[0].LONG],{icon:r});i.on("click",function(){e.$apply(function(){t.url("event_map/"+o.EventID)})}),i.addTo(n)})}var n;e.getMapEventIcon=function(e){return"Flood"==e?"style/images/Flood-Circle-Red.png":"Tsunami"==e?"style/images/Tsunami-Circle-Red.png":"style/images/Earthquake-Circle-Red.png"},e.setCurrentView("events"),e.$on("EventDataLoaded",function(){o()}),e.initMap=function(e){n=e,o()}}]),angular.module("helpNow").controller("EventMapCtrl",["$scope","$http","$routeParams","$resource",function(e,t,o,n){function r(t){e.helpRequest.LAT=t.coords.latitude,e.helpRequest.LONG=t.coords.longitude,g.removeLayer(e.locationOutline),e.locationOutline=L.circle([t.coords.latitude,t.coords.longitude],e.overlayRadius).addTo(g),e.$digest()}function i(){return e.showMedicalNeed=!1,e.showShelterNeed=!1,e.showFoodNeed=!1,e.showWaterNeed=!1,e.showEvacuationNeed=!1,e.showMedicineNeed=!1,!1}function a(){if(e.locations){var t=e.locations.filter(function(e){var t=e.ResourceType.Description;return s(t)});angular.forEach(t,function(t){var o=L.icon({iconUrl:e.getLocationIcon(t.ResourceType.Description),iconSize:[60,60],iconAnchor:[30,30]}),n=L.marker([t.ResourceLocation.LAT,t.ResourceLocation.LONG],{icon:o});n.bindPopup("<strong>"+t.ResourceType.Description+" ("+t.ResourceLocation.ResourceRegistry.Organization.Name+")</strong><br/>"+t.ResourceLocation.PhoneNumber),d.push(n)})}}function s(t){return"Water"==t&&e.showWater||"Shelter"==t&&e.showShelter||"Food"==t&&e.showFood||"Evacuation"==t&&e.showEvacuation||"First Aid"==t&&e.showMedical||"Medicine"==t&&e.showMedicine}function l(){if(g&&e.events){for(var t=0;t<d.length;t++){var o=d[t];g.removeLayer(o)}d=[];e.requests.filter(function(e){var t=e.ResourceType.Description;return s(t)});e.showLocationMarkers&&a(),angular.forEach(d,function(e){g.addLayer(e)})}}function u(){e.requestsResource.get({eventID:e.eventID},function(t){e.requests=t.json.requests,e.locations=t.json.locations,l()})}function c(){e.urgencyResource.get({},function(t){e.urgencyList=t.json})}function p(){var o=JSON.stringify(e.helpRequest),n=t({method:"POST",url:"/api/resourcerequest",async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(e){alert("Request successfully submitted")},function(e){alert("Error: ")})}var g,d=[];e.setCurrentView("event-map"),e.requestsResource=n("/api/event/mapitems/:eventID"),e.urgencyResource=n("/api/requesturgency"),e.needRequestResource=n("/api/resourcerequest"),e.helpRequest={EventID:"",RequestStateID:"1",Notes:"Reported from App",AreaSize:"",UnitOfMeasure:"",Quantity:"",RequestUrgencyID:"1"},e.eventID=1*o.eventID,e.events&&(e.event=e.getEvent(e.eventID),u(),c()),e.requests=[],e.overlayRadius=250,e.radiusRawVal=.25,e.sliderLabel="0.25 km",e.isMetric=!0,e.showFilters=!1,e.showEventDetails=!0,e.showHelp=!1,e.showNeeds=!1,e.showMedical=!0,e.showShelter=!0,e.showFood=!0,e.showWater=!0,e.showEvacuation=!0,e.showMedicine=!0,e.showLocationMarkers=!0,e.locationPref={value:"Current"},e.getLocation=function(){"Current"==e.locationPref.value?navigator.geolocation&&navigator.geolocation.getCurrentPosition(r):(g.removeLayer(e.locationOutline),e.helpRequest.LAT="",e.helpRequest.LONG="",e.$digest())},e.showValue=function(){0==e.radiusRawVal&&(e.radiusRawVal=.05),e.isMetric?(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" km"):(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" mi"),e.helpRequest.AreaSize=e.sliderLabel,void 0!=e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)},e.changeUnits=function(){e.isMetric?(e.sliderLabel=e.radiusRawVal+" km",e.overlayRadius=e.overlayRadius/.62137119,void 0!=e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)):(e.sliderLabel=e.radiusRawVal+" mi",e.overlayRadius=.62137119*e.overlayRadius,void 0!=e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)),e.helpRequest.AreaSize=e.sliderLabel},e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),u(),c(),i(),l()}),e.toggleButtonClass=function(t){var o=e[t];return o?"btn btn-toggle active":"btn btn-toggle"},e.toggleButton=function(t){return e[t]=!e[t],l(),!1},e.toggleNeed=function(t){return e[t]=!e[t],!1},e.initMap=function(t){g=t,g.on("click",function(t){"Other"==e.locationPref.value&&(void 0!==e.locationOutline&&g.removeLayer(e.locationOutline),e.locationOutline=L.circle(t.latlng,e.overlayRadius).addTo(g),e.helpRequest.LAT=t.latlng.lat.toFixed(3),e.helpRequest.LONG=t.latlng.lng.toFixed(3),e.$digest())}),l()},e.filterButtonClass=function(){return e.showFilters?"glyphicon glyphicon-eye-close":"glyphicon glyphicon-eye-open"},e.filterButtonText=function(){return e.showFilters?"Hide":"Show"},e.toggleFilters=function(){return e.showFilters=!e.showFilters,!1},e.toggleHelp=function(){return e.showEventDetails=!e.showEventDetails,e.showHelp=!e.showHelp,!1},e.toggleNeeds=function(){var t=!1;return e.showHelp&&("Other"!=e.locationPref.value||void 0!=e.helpRequest.LAT&&void 0!=e.helpRequest.LONG||(t=!0),void 0==e.helpRequest.AreaSize&&(t=!0),(void 0==e.helpRequest.Quantity||0==e.helpRequest.Quantity)&&(t=!0)),t?alert("Missing Required Field(s)"):(e.showHelp=!e.showHelp,e.showNeeds=!e.showNeeds),!1},e.validateNumber=function(e){var t=e||window.event,o=t.keyCode||t.which;return!t.shiftKey&&!t.altKey&&!t.ctrlKey&&o>=48&&57>=o||8==o||9==o||13==o||37==o||39==o||46==o||45==o?!1:(t.returnValue=!1,t.preventDefault&&t.preventDefault(),!0)},e.sendNeedRequest=function(){var t=!1;if(e.showNeeds&&(e.showMedicalNeed||e.showShelterNeed||e.showFoodNeed||e.showMedicineNeed||e.showWaterNeed||e.showEvacuationNeed||(t=!0)),t)alert("Specify a Need");else{e.helpRequest.EventID=e.eventID;var o=e.helpRequest.AreaSize.split(" ");e.helpRequest.AreaSize=o[0],e.helpRequest.UnitOfMeasure=o[1],e.showMedicalNeed&&(e.helpRequest.ResourceTypeID="4",p()),e.showShelterNeed&&(e.helpRequest.ResourceTypeID="3",alert("Needs Shelter"),p()),e.showFoodNeed&&(e.helpRequest.ResourceTypeID="1",alert("Needs Food"),p()),e.showMedicineNeed&&(e.helpRequest.ResourceTypeID="6",alert("Needs Medicine"),p()),e.showWaterNeed&&(e.helpRequest.ResourceTypeID="2",alert("Needs Water"),p()),e.showEvacuationNeed&&(e.helpRequest.ResourceTypeID="5",alert("Needs Evacuation"),p()),i(),g.removeLayer(e.locationOutline),e.showNeeds=!e.showNeeds,e.showEventDetails=!e.showEventDetails}return!1}}]),angular.module("helpNow").controller("GovLoginCtrl",["$scope",function(e){e.setCurrentView("govs")}]),angular.module("helpNow").controller("IndLoginCtrl",["$scope",function(e){e.setCurrentView("inds")}]),angular.module("helpNow").controller("InventoryCtrl",["$scope","$http","$routeParams","$resource",function(e,t,o,n){function r(){if(s&&e.events){for(var t=0;t<l.length;t++){var o=l[t];s.removeLayer(o)}l=[];e.requests.filter(function(e){var t=e.ResourceType.Description;return shouldDisplayMarker(t)});e.showLocationMarkers&&buildLocationMarkers(),angular.forEach(l,function(e){s.addLayer(e)})}}function i(){e.registryResource.get({},function(t){e.registries=t.json;var o=e.registries.filter(function(t){return t.OrganizationID==e.userOrgID});e.registries=o})}function a(){e.requestsResource.get({eventID:e.eventID},function(t){e.requests=t.json.requests,e.locations=t.json.locations,r()})}var s,l=[];e.setCurrentView("inventory"),e.requestsResource=n("/api/event/mapitems/"),e.registryResource=n("/api/resourceregistry"),e.eventID=1*o.eventID,e.events&&(e.event=e.getEvent(e.eventID),i()),e.userOrgID=1,e.overlayRadius=250,e.radiusRawVal=.25,e.sliderLabel="0.25 km",e.isMetric=!0,e.showRegistries=!0,e.showNewForm=!1,e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),i(),a(),resetNeedsButtons(),r()}),e.initMap=function(t){s=t,s.on("click",function(t){"Other"==e.locationPref.value&&(void 0!==e.locationOutline&&s.removeLayer(e.locationOutline),e.locationOutline=L.circle(t.latlng,e.overlayRadius).addTo(s),e.helpRequest.LAT=t.latlng.lat.toFixed(3),e.helpRequest.LONG=t.latlng.lng.toFixed(3),e.$digest())}),r()},e.showNewSiteForm=function(){return e.showNewForm=!e.showNewForm,e.showRegistries=!e.showRegistries,!1},e.validateNumber=function(e){var t=e||window.event,o=t.keyCode||t.which;return!t.shiftKey&&!t.altKey&&!t.ctrlKey&&o>=48&&57>=o||8==o||9==o||13==o||37==o||39==o||46==o||45==o?!1:(t.returnValue=!1,t.preventDefault&&t.preventDefault(),!0)}}]),angular.module("helpNow").controller("OrgEventCtrl",["$scope","$routeParams","$resource",function(e,t,o){function n(e){return"Water"==e?"style/images/markers/marker-blue.png":"First Aid"==e?"style/images/markers/marker-red.png":"Shelter"==e?"style/images/markers/marker-orange.png":"Evacuation"==e?"style/images/markers/marker-purple.png":"Medicine"==e?"style/images/markers/marker-cyan.png":"style/images/markers/marker-green.png"}function r(e){return"Water"==e?"style/images/Water-Circle-Red.png":"First Aid"==e?"style/images/First Aid-Circle-Red.png":"Shelter"==e?"style/images/Shelter-Circle-Red.png":"Evacuation"==e?"style/images/Evacuation-Circle-Red.png":"Medicine"==e?"style/images/Medicine-Circle-Red.png":"style/images/Food-Circle-Red.png"}function i(e){angular.forEach(e,function(e){var t=L.icon({iconUrl:n(e.ResourceType.Description),iconSize:[27,41],iconAnchor:[13,41],popupAnchor:[0,-20]}),o=L.marker([e.LAT,e.LONG],{icon:t});o.bindPopup("<strong>"+e.ResourceType.Description+" ("+e.Quantity+")</strong><br/>"+e.Notes),d.push(o)})}function a(){if(e.requestClusters){var t=e.requestClusters.filter(function(e){var t=e.ResourceType.Description;return u(t)});angular.forEach(t,function(e){var t=L.icon({iconUrl:r(e.ResourceType.Description),iconSize:[50,50],iconAnchor:[25,25]}),o=L.marker([e.LAT,e.LONG],{icon:t});o.bindPopup("<strong>"+e.ResourceType.Description+"</strong><br/>"+e.Notes),d.push(o)})}}function s(e){var t={radius:100,maxOpacity:.5,scaleRadius:!1,useLocalExtrema:!0,latField:"LAT",lngField:"LONG",valueField:"Quantity"},o=new HeatmapOverlay(t),n={data:e};o.setData(n),d.push(o)}function l(){if(e.locations){var t=e.locations.filter(function(e){var t=e.ResourceType.Description;return u(t)});angular.forEach(t,function(t){var o=L.icon({iconUrl:e.getLocationIcon(t.ResourceType.Description),iconSize:[60,60],iconAnchor:[30,30]}),n=L.marker([t.ResourceLocation.LAT,t.ResourceLocation.LONG],{icon:o});n.bindPopup("<strong>"+t.ResourceType.Description+" ("+t.ResourceLocation.ResourceRegistry.Organization.Name+")</strong><br/>"+t.ResourceLocation.PhoneNumber),d.push(n)})}}function u(t){return"Water"==t&&e.showWater||"Shelter"==t&&e.showShelter||"Food"==t&&e.showFood||"Evacuation"==t&&e.showEvacuation||"First Aid"==t&&e.showMedical||"Medicine"==t&&e.showMedicine}function c(){if(g&&e.events){for(var t=0;t<d.length;t++){var o=d[t];g.removeLayer(o)}d=[];var n=e.requests.filter(function(e){var t=e.ResourceType.Description;return u(t)});e.showHeatmap&&s(n),e.showNeedsMarkers&&i(n),e.showClusters&&a(),e.showLocationMarkers&&l(),angular.forEach(d,function(e){g.addLayer(e)})}}function p(){e.requestsResource.get({eventID:e.eventID},function(t){e.requests=t.json.requests,e.locations=t.json.locations,e.requestClusters=t.json.requestClusters,c()})}var g,d=[];e.setCurrentView("org-events"),e.requestsResource=o("/api/event/mapitems/:eventID"),e.eventID=1*t.eventID,e.events&&(e.event=e.getEvent(e.eventID),p()),e.requests=[],e.showFilters=!1,e.showMedical=!0,e.showShelter=!0,e.showFood=!0,e.showWater=!0,e.showEvacuation=!0,e.showMedicine=!0,e.showHeatmap=!1,e.showClusters=!1,e.showNeedsMarkers=!0,e.showLocationMarkers=!1,e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),p(),c()}),e.toggleButtonClass=function(t){var o=e[t];return o?"btn btn-toggle active":"btn btn-toggle"},e.toggleButton=function(t){return e[t]=!e[t],c(),!1},e.initMap=function(e){g=e,c()},e.filterButtonClass=function(){return e.showFilters?"glyphicon glyphicon-eye-close":"glyphicon glyphicon-eye-open"},e.filterButtonText=function(){return e.showFilters?"Hide":"Show"},e.toggleFilters=function(){return e.showFilters=!e.showFilters,!1},e.setCurrentView("org-event")}]),angular.module("helpNow").controller("OrgLoginCtrl",["$scope",function(e){e.setCurrentView("orgs")}]),angular.module("helpNow").controller("RootCtrl",["$scope","$http","$resource",function(e,t,o){var n="Eng",r="";e.eventsResource=o("/api/event"),e.loadEvents=function(){e.eventsResource.get({},function(t){e.events=t.json,e.$broadcast("EventDataLoaded",{})})},e.getEventIcon=function(e){return"Flood"==e?"style/images/Flood.png":"Tsunami"==e?"style/images/Tsunami.png":"style/images/Earthquake.png"},e.getMenuClass=function(e){return e==r?"active":""},e.setCurrentView=function(e){r=e},e.setCurrentLanguage=function(o){n=o,"Ben"==o?t.get("i18n/text-BEN.json").success(function(t){e.text=t}).error(function(e){alert(e)}):t.get("i18n/text-ENG.json").success(function(t){e.text=t}).error(function(e){alert(e)})},e.getLanguageClass=function(e){return n==e?"active":""},e.setCurrentLanguage("Eng"),e.getResourcesForEvent=function(t){for(var o=[],n=0;n<e.resources.length;n++){var r=e.resources[n];r.eventID==t&&o.push(r)}return o.length>0?o:{}},e.getEvent=function(t){for(var o=0;o<e.events.length;o++){var n=e.events[o];if(n.EventID==t)return n}return{}},e.getLocationIcon=function(e){return"Water"==e?"style/images/Water-Diamond-Blue.png":"First Aid"==e?"style/images/First Aid-Diamond-Blue.png":"Shelter"==e?"style/images/Shelter-Diamond-Blue.png":"Evacuation"==e?"style/images/Evacuation-Hexagon.png":"Medicine"==e?"style/images/Medicine-Diamond-Blue.png":"style/images/Food-Diamond-Blue.png"},e.loadEvents(),e.resources=[{id:1,eventID:1,resourceType:"First Aid",lat:23.718,"long":90.355,provider:"NGO #1",message:""},{id:2,eventID:1,resourceType:"First Aid",lat:23.719,"long":90.374,provider:"NGO #2",message:""},{id:3,eventID:1,resourceType:"First Aid",lat:23.765,"long":90.398,provider:"NGO #3",message:""},{id:4,eventID:1,resourceType:"Water",lat:23.767,"long":90.41,provider:"NGO #4",message:""},{id:5,eventID:1,resourceType:"Evacuation Site",lat:23.73,"long":90.365,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."},{id:6,eventID:1,resourceType:"Evacuation Site",lat:23.75,"long":90.43,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."}]}]),angular.module("helpNow").directive("map",function(){return{link:function(e,t,o){var n=o.mapCenter.split(","),r=o.mapZoom,i="pk.eyJ1IjoiZGlnaXRhbGdsb2JlIiwiYSI6ImNpZjc5N3NiMTA5OXlzb2x6c3FyZHQ3cTUifQ.88yZYJc78Z2MAnkX2fOjuw",a='Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery � <a href="http://mapbox.com">Mapbox</a>',s="https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ",l=(L.tileLayer(s,{id:"mapbox.light",attribution:a}),L.tileLayer(s,{id:"mapbox.streets",attribution:a})),u=L.esri.tiledMapLayer({url:"https://services.digitalglobe.com/earthservice/gis/0688362c-8f94-4016-95c3-172c2ab72023/rest/services/DigitalGlobe:ImageryTileService/MapServer",attribution:"DigitalGlobe Basemap, 2015"}),c=(L.tileLayer.wms("https://services.digitalglobe.com/mapservice/wmsaccess?connectid=0688362c-8f94-4016-95c3-172c2ab72023",{layers:"DigitalGlobe:Imagery",format:"image/png",transparent:!0,attribution:"DigitalGlobe 2015"}),L.esri.tiledMapLayer({url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",attribution:"Esri 2015"})),p=new L.tileLayer("https://{s}.tiles.mapbox.com/v4/digitalglobe.n6nhclo2/{z}/{x}/{y}.png?access_token="+i,{minZoom:2,maxZoom:19,attribution:'(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a> , (c) OpenStreetMap, (c) Mapbox'}),g=new L.tileLayer("https://{s}.tiles.mapbox.com/v4/digitalglobe.n6ngnadl/{z}/{x}/{y}.png?access_token="+i,{minZoom:2,maxZoom:19,attribution:'(c) <a href="http://microsites.digitalglobe.com/interactive/basemap_vivid/">DigitalGlobe</a>'}),d=(new L.tileLayer("https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token="+i,{minZoom:2,maxZoom:19,attribution:"(c) OpenStreetMap , (c) Mapbox"}),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:a,noWrap:!0,minZoom:2,maxZoom:18})),v=new L.map("map",{layers:[d],maxBounds:[[-90,-180],[90,180]]}).setView(n,r);L.control.scale().addTo(v),v.attributionControl.setPrefix("");var h={"Base Open Street Maps":d,"DigitalGlobe Basemap +Vivid with Streets":p,"DigitalGlobe Basemap +Vivid":g,"Mapbox + OSM Streets":l,"DigitalGlobe Basemap: REST":u,"Esri World Imagery":c};L.control.layers(h,null,{collapsed:!0}).addTo(v),v.addControl(new L.Control.Search({url:"http://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],circleLocation:!1,markerLocation:!1,autoType:!1,autoCollapse:!0,minLength:2,zoom:13})),e.initMap&&e.initMap(v)}}});