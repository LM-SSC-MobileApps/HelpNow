angular.module("helpNow",["ngRoute","ngResource","ui.bootstrap","ngSanitize","ngCookies"]).config(["$routeProvider",function(e){e.when("/ind_login",{templateUrl:"views/ind-login.html"}),e.when("/login",{templateUrl:"views/login.html"}),e.when("/about",{templateUrl:"views/about.html"}),e.when("/new_event/:eventID",{templateUrl:"views/manage/new-event.html"}),e.when("/new_map_layer/:eventID/:mapLayerID",{templateUrl:"views/manage/new-map-layer.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.when("/event_map/:eventID",{templateUrl:"views/event-map.html"}),e.when("/request_help/:eventID",{templateUrl:"views/event-map.html"}),e.when("/inventory",{templateUrl:"views/inventory/inventory.html"}),e.when("/gov_login",{templateUrl:"views/gov-login.html"}),e.when("/org_event/:eventID",{templateUrl:"views/org-event.html"}),e.when("/create_deployment/:eventID/:lat/:long",{templateUrl:"views/deployment.html"}),e.when("/modify_deployment/:locationID",{templateUrl:"views/deployment.html"}),e.when("/events",{templateUrl:"views/events.html"}),e.when("/manage_events",{templateUrl:"views/manage/manage-events.html"}),e.when("/manage_map_layers",{templateUrl:"views/manage/manage-map-layers.html"}),e.when("/administration/",{templateUrl:"views/admin/administration.html"}),e.when("/add_org/:orgTypeID/:orgID",{templateUrl:"views/admin/add-organization.html"}),e.when("/org_address/:orgID",{templateUrl:"views/manage/org-address.html"}),e.when("/manage/",{templateUrl:"views/manage/manage.html"}),e.when("/tomnod",{templateUrl:"views/manage/tomnod.html"}),e.when("/regulations/",{templateUrl:"views/manage/regulations.html"}),e.when("/regulation_detail/:organizationRegulationsID",{templateUrl:"views/manage/regulation-detail.html"}),e.when("/regulation_edit/:organizationRegulationsID",{templateUrl:"views/manage/regulation-edit.html"}),e.when("/regulation_add/",{templateUrl:"views/manage/regulation-add.html"}),e.when("/regulation_add/",{templateUrl:"views/manage/regulation-add.html"}),e.when("/invite/",{templateUrl:"views/manage/team-invite.html"}),e.when("/assign_poc/",{templateUrl:"views/manage/assign-poc.html"}),e.when("/reg_account/:inviteID",{templateUrl:"views/reg-account.html"}),e.when("/password_reset/:accountID/:guid",{templateUrl:"views/manage/password-reset.html"}),e.when("/forgot_password/",{templateUrl:"views/manage/forgot-password.html"}),e.when("/demo/",{templateUrl:"views/manage/demo.html"}),e.otherwise({templateUrl:"views/events.html"})}]),angular.module("helpNow").controller("AboutCtrl",["$scope","$http","$location","$routeParams","$resource",function(e,t,o,n,r){e.setCurrentView("about"),e.setTitle(e.text.about_title),e.getCurrentLanguage(),"Eng"==e.currentLanguage&&(e.isEnglish=!0)}]),angular.module("helpNow").controller("AdministrationCtrl",["$scope","$location","$resource","Organization","$uibModal",function(e,t,o,n,r){e.setTitle(e.text.admin_title),e.governmentResource=o("/api/organization/type/:id",{id:1}),e.organizationResource=o("/api/organization/type/:id",{id:2}),e.loadGovernments=function(){e.governmentResource.get({},function(t){e.governmentList=t.json,e.$broadcast("GovernmentDataLoaded",{})})},e.loadOrganizations=function(){e.organizationResource.get({},function(t){angular.module("helpNow").controller("AdministrationCtrl",["$scope","$location","$resource","Organization","$uibModal",function(e,t,o,n,r){e.setTitle(e.text.admin_title),e.governmentResource=o("/api/organization/type/:id",{id:1}),e.organizationResource=o("/api/organization/type/:id",{id:2}),e.loadGovernments=function(){e.governmentResource.get({},function(t){e.governmentList=t.json,e.$broadcast("GovernmentDataLoaded",{})})},e.loadOrganizations=function(){e.organizationResource.get({},function(t){e.organizationList=t.json,e.$broadcast("OrganizationDataLoaded",{})})},e.loadGovernments(),e.loadOrganizations(),e.manage=function(o){e.setCurrentOrg(o),t.path("/manage")},e.addOrg=function(o){e.modalInstance=r.open({templateUrl:"/admin/admin-modal-add-org.html",controller:function(e){this.org=o,this.orgType=1==o.OrganizationTypeID?"government":"organization",this.Organization=n,e.addOrg=function(e){n.save(e),t.path("/administration")}},controllerAs:"model"})},e.removeOrg=function(o){e.modalInstance=r.open({templateUrl:"/admin/admin-modal-remove.html",controller:function(e){this.org=o,this.orgType=1==o.OrganizationTypeID?"government":"organization",this.Organization=n,e.removeOrg=function(e){n["delete"]({id:e.OrganizationID}),t.path("/administration")}},controllerAs:"model"})}}]),e.organizationList=t.json,e.$broadcast("OrganizationDataLoaded",{})})},e.loadGovernments(),e.loadOrganizations(),e.manage=function(o){e.setCurrentOrg(o),t.path("/manage")},e.addOrg=function(o){e.modalInstance=r.open({templateUrl:"/admin/admin-modal-add-org.html",controller:function(e){this.org=o,this.orgType=1==o.OrganizationTypeID?"government":"organization",this.Organization=n,e.addOrg=function(e){n.save(e),t.path("/administration")}},controllerAs:"model"})},e.removeOrg=function(o){e.modalInstance=r.open({templateUrl:"/admin/admin-modal-remove.html",controller:function(e){this.org=o,this.orgType=1==o.OrganizationTypeID?"government":"organization",this.Organization=n,e.removeOrg=function(e){n["delete"]({id:e.OrganizationID}),t.path("/administration")}},controllerAs:"model"})}}]),angular.module("helpNow").controller("AssignPocCtrl",["$scope","$resource","$routeParams","Organization","$location","$uibModal",function(e,t,o,n,r,a){e.teamResource=t("/api/account/organizationmembers/:accountid",{accountid:e.currentUser.AccountID}),e.loadTeam=function(){e.teamResource.get({},function(t){e.team=t.json,e.$broadcast("TeamDataLoaded",{})})},e.loadTeam(),e.orgResource=t("/api/organization/:id",{id:e.currentOrg.OrganizationID}),e.loadOrg=function(){e.orgResource.get({},function(t){orgs=t.json,e.org=orgs[0],console.log("org.PrimaryPOC: "+e.org.PrimaryPOC),e.$broadcast("OrgDataLoaded",{})})},e.loadOrg(),e.updateOrg=function(t){n.update({id:e.currentOrg.OrganizationID},t),e.modalInstance=a.open({templateUrl:"/manage/team-poc-modal-confirm.html",scope:e,controller:function(e){this.text=e.text,e.confirm=function(){r.path("/manage")}},controllerAs:"model"})},e.go=function(e){r.path(e)}}]),angular.module("helpNow").controller("DemoCtrl",["$scope","$http","ResourceRequest","$location","ResourceLocation",function(e,t,o,n,r){function a(e){var t,o={EventID:e.EventID,RequestStateID:1},n=10*Math.random();t=3.33>n?"Please help!":n>6.66?"Reported via Facebook":"Reported via Twitter",o.Notes=t,o.Quantity=Math.round(20*Math.random()),o.ResourceTypeID=u.indexOf(e.RequestType);var r=Math.random()*e.Diameter,a=r-.5*e.Diameter;o.LAT=e.CenterLat+a;var i=Math.random()*e.Diameter,s=i-.5*e.Diameter;return o.LONG=e.CenterLong+s,o.RequestUrgencyID=Math.round(4*Math.random())+1,o}function i(e,t){t||(t=e.NumberOfRequests),o.save(a(e),function(o){o.json;t>1&&setTimeout(function(){i(e,t-1)},e.Delay)})}function s(e,o){t.get(e).success(function(e){o(e)}).error(function(e){console.log("Error loading scenario data:  "+e)})}function c(t){e.demoRunning=!0,angular.forEach(t,function(e,t){switch(e.Type){case"RequestGroup":var o=e.Data;setTimeout(function(){i(o)},o.StartDelay);break;default:console.log("I'm lost")}}),e.demoRunning=!1}e.setTitle("Organization Management"),e.setCurrentView("mng"),e.demoRunning=!1,e.go=function(e){n.path(e)};var u=["None","Water","Food","Shelter","First Aid","Clothing","Medicine","Evacuation","Rescue"];e.cleanDatabase=function(){var e=t({method:"DELETE",url:"/api/resourcelocation/deployments/all",async:!0,headers:{"Content-Type":"application/json"}});e.then(function(e){},function(e){console.log(e.data.err)});var o=t({method:"DELETE",url:"/api/resourcerequest",async:!0,headers:{"Content-Type":"application/json"}});o.then(function(e){},function(e){console.log(e.data.err)})},e.runBangladeshScenario=function(){s("data/BangladeshScenario.json",function(e){c(e)})},e.runNepalScenario=function(){s("data/NepalScenario.json",function(e){c(e)})}}]),angular.module("helpNow").controller("DeploymentCtrl",["$scope","$routeParams","$resource","$sce","$location","$http",function(e,t,o,n,r,a){function i(){var t=JSON.stringify(e.deployment),o=a({method:"POST",url:"/api/resourcelocation",async:!0,headers:{"Content-Type":"application/json"},data:t});o.then(function(t){e.deployment.ResourceLocationID=t.data.json.ResourceLocationID},function(e){alert(e.data.err)})}function s(){var t=JSON.stringify(e.deployment),o=a({method:"PUT",url:"/api/resourcelocation/"+e.deployment.ResourceLocationID,async:!0,headers:{"Content-Type":"application/json"},data:t});o.then(function(e){},function(e){console.log(e),alert("error: "+e.data.err)})}e.showDistributionCenters=!1,e.deploymentsResource=o("/api/resourcelocation/:id"),e.distCenterResource=o("/api/resourcelocation/dist-center/all"),e.setTitle(e.text.deployment_title,"style/images/Distribution-Center.png"),e.distCenterResource.get({},function(t){var o=t.json;o=o.filter(function(t){return t.OrganizationID==e.currentOrg.OrganizationID}),e.distCenters=o}),t.locationID?(e.deployment={},e.deploymentsResource.get({id:t.locationID},function(t){var o=t.json[0];o.ResourceLocationStatusID=o.ResourceLocationStatusID+"",e.deployment=o,e.events&&(e.event=e.getEvent(e.deployment.EventID))})):e.deployment={EventID:t.eventID,LAT:t.lat,LONG:t["long"],ResourceLocationTypeID:2,OrganizationID:e.currentOrg.OrganizationID,ResourceLocationStatusID:"1",ResourceLocationTransports:[],ResourceLocationInventories:[]},e.events&&(e.event=e.getEvent(e.deployment.EventID)),e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.deployment.EventID)}),e.cancel=function(){var t="org_event/"+e.deployment.EventID;r.path(t)},e.removeInventory=function(t){var o=a({method:"DELETE",url:"/api/resourcelocationinventory/"+t.ResourceLocationInventoryID,async:!0,headers:{"Content-Type":"application/json"}});o.then(function(o){for(var n=e.deployment.ResourceLocationInventories,r=0,a=0;a<n.length;a++){var i=n[a];if(t.ResourceLocationInventoryID==i.ResourceLocationInventoryID){r=a;break}}e.deployment.ResourceLocationInventories.splice(r,1)},function(e){alert(e.data.err)})},e.saveDeployment=function(){e.deployment.ResourceLocationID?s():i()},e.addResources=function(t){delete t.ResourceLocationInventoryID,t.SourceLocationID=t.ResourceLocationID,t.ResourceLocationID=e.deployment.ResourceLocationID;var o=JSON.stringify(t),n=a({method:"POST",url:"/api/resourcelocationinventory",async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(o){t.ResourceLocationInventoryID=o.data.json.ResourceLocationInventoryID,e.deployment.ResourceLocationInventories.push(t),e.showDistributionCenters=!1},function(e){console.log(e.data),alert("error: "+e.data.err)})},e.getResourceIcon=function(e){var t=e.ResourceType.Description;return"Water"==t?"style/images/Water-Diamond-Blue.png":"First Aid"==t?"style/images/First Aid-Diamond-Blue.png":"Shelter"==t?"style/images/Shelter-Diamond-Blue.png":"Evacuation"==t?"style/images/Evacuation-Diamond-Blue.png":"Medicine"==t?"style/images/Medicine-Diamond-Blue.png":"style/images/Food-Diamond-Blue.png"},e.toggleDistributionCenters=function(){e.showDistributionCenters=!e.showDistributionCenters}}]),angular.module("helpNow").controller("EventListCtrl",["$scope","$location",function(e,t){function o(){n&&e.events&&angular.forEach(e.events,function(o){var r=L.icon({iconUrl:e.getMapEventIcon(o.EventType.Description),iconSize:[43,44]}),a=L.marker([o.EventLocations[0].LAT,o.EventLocations[0].LONG],{icon:r});a.on("click",function(){e.$apply(function(){e.isLoggedIn?t.url("org_event/"+o.EventID):t.url("event_map/"+o.EventID)})}),a.addTo(n)})}var n;e.setTitle(e.text.events_title),e.user=e.getCurrentUser(),null==e.user||0==e.user?e.isLoggedIn=!1:e.isLoggedIn=!0,e.getMapEventIcon=function(e){return"Flood"==e?"style/images/Flood-Circle-Red.png":"Tsunami"==e?"style/images/Tsunami-Circle-Red.png":"style/images/Earthquake-Circle-Red.png"},e.setCurrentView("events"),e.$on("EventDataLoaded",function(){o()}),e.initMap=function(e){n=e,o()}}]),angular.module("helpNow").controller("EventMapCtrl",["$scope","$http","$routeParams","$resource","$location",function(e,t,o,n,r){function a(){"Current"==e.locationPref.value?navigator.geolocation&&navigator.geolocation.getCurrentPosition(i):(p.removeLayer(e.locationOutline),e.helpRequest.LAT="",e.helpRequest.LONG="",e.digest())}function i(t){e.helpRequest.LAT=t.coords.latitude,e.helpRequest.LONG=t.coords.longitude,void 0!==e.locationOutline&&p.removeLayer(e.locationOutline),e.locationOutline=L.circle([t.coords.latitude,t.coords.longitude],e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(p),e.$digest()}function s(){var t=e.needFlags;return t.showMedical=!1,t.showShelter=!1,t.showFood=!1,t.showWater=!1,t.showEvacuation=!1,t.showMedicine=!1,!1}function c(){if(p&&e.events){for(var t=0;t<g.length;t++){var o=g[t];p.removeLayer(o)}g=[],e.showLocationMarkers&&e.buildLocationMarkers(e.locations,g,e.filterFlags),angular.forEach(g,function(e){p.addLayer(e)})}}function u(){e.requestsResource.get({eventID:e.eventID},function(t){e.requests=t.json.requests,e.locations=t.json.locations,c()})}function l(){e.urgencyResource.get({},function(t){e.urgencyList=t.json,e.selectedUrgency=e.urgencyList[0],e.helpRequest.RequestUrgencyID=e.selectedUrgency.RequestUrgencyID})}function d(){var o=JSON.stringify(e.helpRequest),n=t({method:"POST",url:"/api/resourcerequest",async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(e){},function(t){alert("Error: "),e.hasSubmissionError=!0})}var p,g=[];e.setCurrentView("event-map"),e.requestsResource=n("/api/event/mapitems/:eventID"),e.urgencyResource=n("/api/requesturgency"),e.needRequestResource=n("/api/resourcerequest"),e.helpRequest={EventID:"",RequestStateID:"1",Notes:"Reported from App",AreaSize:"0.25 km",UnitOfMeasure:"",Quantity:""},e.eventID=1*o.eventID,e.events&&(e.event=e.getEvent(e.eventID),e.setTitle(e.event.EventLocations[0].Description,e.getEventIcon(e.event.EventType.Description)),u(),l()),e.requests=[],e.overlayRadius=250,e.radiusRawVal=.25,e.sliderLabel="0.25 km",e.isMetric=!0,e.showFilters=!1,e.showEventDetails=!0,e.showHelp=!1,e.showNeeds=!1;var m=JSON.parse(sessionStorage.getItem("filterFlags"));null!=m?e.filterFlags=JSON.parse(sessionStorage.getItem("filterFlags")):e.filterFlags={showMedical:!0,showShelter:!0,showFood:!0,showWater:!0,showClothing:!0,showRescue:!0,showEvacuation:!0,showMedicine:!0},e.needFlags={showMedical:!1,showShelter:!1,showFood:!1,showWater:!1,showClothing:!1,showRescue:!1,showEvacuation:!1,showMedicine:!1},e.showLocationMarkers=!0,e.locationPref={value:"Current"},e.toggleHelp=function(){return e.showEventDetails=!e.showEventDetails,e.showHelp=!e.showHelp,a(),!1},0==r.path().search("/request_help/")&&e.toggleHelp(),e.getLocation=function(){a()},e.centerMapToLongLat=function(e,t){p&&(p.setZoom(13),p.panTo(new L.LatLng(e,t)))},e.getSelectedUrgency=function(){e.helpRequest.RequestUrgencyID=e.selectedUrgency.RequestUrgencyID},e.showValue=function(){0==e.radiusRawVal&&(e.radiusRawVal=.05),e.isMetric?(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" km"):(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" mi"),e.helpRequest.AreaSize=e.sliderLabel,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)},e.changeUnits=function(){e.isMetric?(e.sliderLabel=e.radiusRawVal+" km",e.overlayRadius=e.overlayRadius/.62137119,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)):(e.sliderLabel=e.radiusRawVal+" mi",e.overlayRadius=.62137119*e.overlayRadius,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)),e.helpRequest.AreaSize=e.sliderLabel},e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),u(),l(),s(),c()}),e.toggleButtonClass=function(t){var o=e[t];return o?"btn btn-toggle active":"btn btn-toggle"},e.toggleButton=function(t){var o=e.filterFlags;return o[t]=!o[t],c(),!1},e.toggleFilterClass=function(t){var o=e.filterFlags,n=o[t];return n?"btn btn-toggle active":"btn btn-toggle"},e.toggleNeedsClass=function(t){var o=e.needFlags,n=o[t];return n?"btn btn-toggle active":"btn btn-toggle"},e.toggleNeed=function(t){var o=e.needFlags;return o[t]=!o[t],!1},e.initMap=function(t){p=t,p.on("click",function(t){"Other"==e.locationPref.value&&(void 0!==e.locationOutline&&p.removeLayer(e.locationOutline),e.locationOutline=L.circle(t.latlng,e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(p),e.helpRequest.LAT=t.latlng.lat.toFixed(3),e.helpRequest.LONG=t.latlng.lng.toFixed(3),e.$digest())}),c()},e.filterButtonClass=function(){return e.showFilters?"glyphicon glyphicon-eye-close":"glyphicon glyphicon-eye-open"},e.filterButtonText=function(){return e.showFilters?"Hide":"Show"},e.toggleFilters=function(){var t={showMedical:e.filterFlags.showMedical,showShelter:e.filterFlags.showShelter,showFood:e.filterFlags.showFood,showWater:e.filterFlags.showWater,showClothing:e.filterFlags.showClothing,showRescue:e.filterFlags.showRescue,showEvacuation:e.filterFlags.showEvacuation,showMedicine:e.filterFlags.showMedicine};return sessionStorage.setItem("filterFlags",JSON.stringify(t)),e.showFilters=!e.showFilters,!1},e.toggleNeeds=function(){var t=!1;return e.showHelp&&("Other"!=e.locationPref.value||void 0!==e.helpRequest.LAT&&""!=e.helpRequest.LAT&&void 0!==e.helpRequest.LONG&&""!=e.helpRequest.LONG||(t=!0),void 0===e.helpRequest.AreaSize&&(t=!0),(void 0===e.helpRequest.Quantity||0==e.helpRequest.Quantity)&&(t=!0)),t?alert(e.text.missing_fields_alert):(e.showHelp=!e.showHelp,e.showNeeds=!e.showNeeds),!1},e.validateNumber=function(e){var t=e||window.event,o=t.keyCode||t.which;return!t.shiftKey&&!t.altKey&&!t.ctrlKey&&o>=48&&57>=o||8==o||9==o||13==o||37==o||39==o||46==o||45==o?!1:(t.returnValue=!1,t.preventDefault&&t.preventDefault(),!0)},e.sendNeedRequest=function(){var t=!1,o=e.needFlags;if(e.showNeeds&&(o.showMedical||o.showShelter||o.showFood||o.showMedicine||o.showWater||o.showClothing||o.showRescue||o.showEvacuation||(t=!0)),t)alert("Specify a Need");else{e.helpRequest.EventID=e.eventID;var n=e.helpRequest.AreaSize.split(" ");e.helpRequest.AreaSize=n[0],e.helpRequest.UnitOfMeasure=n[1],o.showMedicalNeed&&(e.helpRequest.ResourceTypeID="4",d()),o.showShelter&&(e.helpRequest.ResourceTypeID="3",d()),o.showFood&&(e.helpRequest.ResourceTypeID="2",d()),o.showMedicine&&(e.helpRequest.ResourceTypeID="6",d()),o.showWater&&(e.helpRequest.ResourceTypeID="1",d()),o.showClothing&&(e.helpRequest.ResourceTypeID="5",d()),o.showRescue&&(e.helpRequest.ResourceTypeID="8",d()),o.showEvacuation&&(e.helpRequest.ResourceTypeID="7",d()),s(),p.removeLayer(e.locationOutline),e.showNeeds=!e.showNeeds,e.showEventDetails=!e.showEventDetails,e.hasSubmissionError||alert(e.text.need_request_success)}return!1}}]),angular.module("helpNow").controller("ForgotPasswordCtrl",["$scope","$http","Account","$location","$routeParams","$resource",function(e,t,o,n,r,a){e.setCurrentView("forgot_password"),e.setTitle(e.text.forgot_password_title),e.emailAddress="",e.accountResource=a("/api/inviterequest/passwordreset"),e.sendEmail=function(){var o="Email="+e.emailAddress,r=t({method:"POST",url:"/api/inviterequest/passwordreset",async:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:o});r.then(function(e){1==e.data.json?n.path("#"):alert("Error: "+e.data.err)})}}]),angular.module("helpNow").controller("GovLoginCtrl",["$scope",function(e){e.setCurrentView("govs")}]),angular.module("helpNow").controller("IndLoginCtrl",["$scope",function(e){e.setCurrentView("inds")}]),angular.module("helpNow").controller("InventoryCtrl",["$scope","$http","$routeParams","ResourceLocation","ResourceLocationInventory","ResourceLocationTransport","$resource","$uibModal",function(e,t,o,n,r,a,i,s){function c(){null!==e.currentUser?e.resourceLocationResource.get({orgid:e.currentUser.OrganizationID},function(t){e.resourceLocations=t.json,e.$broadcast("ResourceLocationDataLoaded",{})}):(e.showResourceLocations=!1,m())}function u(){e.locationTypeResource.get({},function(t){e.resourceLocationTypes=t.json})}function l(){e.locationStatusResource.get({},function(t){e.resourceLocationStatuses=t.json})}function d(){e.transportTypeResource.get({},function(t){e.transportTypes=t.json})}function p(){e.resourceTypeResource.get({},function(t){e.resourceTypes=t.json.filter(function(e){return"Evacuation"!=e.Description})})}function g(){e.resourceTypeUnitOfMeasureResource.get({},function(t){e.resourceTypeUnitOfMeasures=t.json})}function m(){if(D&&e.resourceLocations){for(var t=0;t<I.length;t++){var o=I[t];D.removeLayer(o)}I=[],h(I),angular.forEach(I,function(e){D.addLayer(e)})}}function h(t){angular.forEach(e.resourceLocations,function(e){var o=L.icon({iconUrl:"style/images/Resources-Box-Blue.png",iconSize:[60,60],iconAnchor:[30,30]}),n=v(e,o);t.push(n)})}function v(e,t){var o=L.marker([e.LAT,e.LONG],{icon:t});return o.id=e.ResourceLocationID,o.bindPopup(f(e)),o}function f(e){var t="<strong>"+e.Description+"</strong><br/>"+e.PrimaryPOCPhone+"<hr/>";return"undefined"!=typeof e.ResourceLocationInventories&&e.ResourceLocationInventories.forEach(function(e){t+=e.ResourceType.Description+": "+e.Quantity+" "+e.ResourceTypeUnitOfMeasure.Description+"<br/>"}),t}function y(){"Current"==e.locationPref.value?navigator.geolocation&&navigator.geolocation.getCurrentPosition(w):(void 0!==e.locationOutline&&D.removeLayer(e.locationOutline),e.currentResourceLocation.LAT="",e.currentResourceLocation.LONG="")}function w(t){e.currentResourceLocation.LAT=t.coords.latitude,e.currentResourceLocation.LONG=t.coords.longitude,void 0!==e.locationOutline&&D.removeLayer(e.locationOutline),e.locationOutline=L.circle([t.coords.latitude,t.coords.longitude],e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(D),e.$digest(),e.centerMapToLongLat(t.coords.latitude,t.coords.longitude,7)}function R(t){var o=null;return e.resourceTypesFiltered[0].ResourceSubtypes.forEach(function(e){e.ResourceSubtypeID==t&&(o=e)}),o}var D,I=[];e.setTitle("Inventory Managenent"),e.setCurrentView("inventory"),e.resourceLocationResource=i("/api/resourcelocation/dist-center/organization/:orgid",{orgid:"@orgid"}),e.locationTypeResource=i("/api/resourcelocationtype/",{}),e.locationStatusResource=i("/api/resourcelocationstatus/",{}),e.transportTypeResource=i("/api/transporttype/",{}),e.resourceTypeResource=i("/api/resourcetype/",{}),e.resourceTypeUnitOfMeasureResource=i("/api/resourcetypeunitofmeasure/",{}),e.currentResourceLocation=new n,e.currentResourceLocationInventory=new r,e.transportTypes=[],e.overlayRadius=250,e.radiusRawVal=.25,e.sliderLabel="0.25 km",e.isMetric=!0,e.showResourceLocations=!0,e.showLocationForm=!1,e.showTransportationOptionsForm=!1,e.showResourceLocation=!1,e.showResourceTypes=!1,e.editMode=!1,e.showAir=!1,e.showGround=!1,e.showWater=!1,e.resourcesFiltered=!1,e.resourceLocationInventoryEdit=!1,d(),u(),l(),c(),p(),g(),e.$on("ResourceLocationDataLoaded",function(){e.showLocationsDiv(),m()}),e.centerMapToLongLat=function(e,t,o){D&&(D.setZoom(o),D.panTo(new L.LatLng(e,t)))},e.showLocationMarkers=!0,e.locationPref={value:"Current"},e.getLocation=function(){y()},e.initMap=function(t){D=t,D.on("click",function(t){"Other"==e.locationPref.value&&(void 0!==e.locationOutline&&D.removeLayer(e.locationOutline),e.locationOutline=L.circle(t.latlng,e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(D),e.currentResourceLocation.LAT=t.latlng.lat.toFixed(3),e.currentResourceLocation.LONG=t.latlng.lng.toFixed(3),e.$digest())}),m()},e.resourceLocationClick=function(t,o,n){D&&(e.centerMapToLongLat(t,o,13),e.setCurrentResourceLocationByID(n),e.showResourceLocationDiv())},e.setCurrentResourceLocationByID=function(t){e.resourceLocations.forEach(function(o){o.ResourceLocationID==t&&(e.currentResourceLocation=o)})},e.setTransportationType=function(t){var o=e.currentResourceLocation.ResourceLocationTransports.map(function(e){return e.TransportTypeID}).indexOf(t);if(-1!=o)e.currentResourceLocation.ResourceLocationTransports.splice(o,1);else{var n=new a;n.TransportTypeID=t,n.ResourceLocationID=e.currentResourceLocation.ResourceLocationID,e.currentResourceLocation.ResourceLocationTransports.push(n)}return!1},e.setResourceLocationType=function(t){return e.currentResourceLocation.ResourceLocationType=t,e.currentResourceLocation.ResourceLocationTypeID=t.ResourceLocationTypeID,!1},e.setDefaultResourceLocationType=function(){var t=e.resourceLocationTypes.map(function(e){return e.Description}).indexOf("Distribution Center");return e.resourceLocationTypes[t]},e.setDefaultResourceLocationStatus=function(){var t=e.resourceLocationStatuses.map(function(e){return e.Status}).indexOf("Active");return e.resourceLocationStatuses[t]},e.createNewResourceLocation=function(){var t=new n;t.ResourceLocationTransports=[],t.OrganizationID=e.currentUser.OrganizationID;var o=e.setDefaultResourceLocationType();t.ResourceLocationType=o,t.ResourceLocationTypeID=o.ResourceLocationTypeID;var r=e.setDefaultResourceLocationStatus();return t.ResourceLocationStatus=r,t.ResourceLocationStatusID=r.ResourceLocationStatusID,t},e.showNewEditForm=function(t){if(e.showAir=!1,e.showGround=!1,e.showWater=!1,t){e.editMode=!0;var o=e.resourceLocations.map(function(e){return e.ResourceLocationID}).indexOf(t);e.currentResourceLocation=e.resourceLocations[o],e.locationPref.value="Other",e.currentResourceLocation.ResourceLocationTransports.forEach(function(t){var o=e.transportTypes.map(function(e){return e.TransportTypeID}).indexOf(t.TransportTypeID),n=e.transportTypes[o];"Ground"==n.Description?e.showGround=!0:"Air"==n.Description?e.showAir=!0:"Water"==n.Description&&(e.showWater=!0)})}else e.editMode=!1,e.currentResourceLocation=e.createNewResourceLocation(),e.locationPref.value="Other",e.getLocation();return e.showLocationDiv(),!1},e.showLocationDiv=function(){return e.showLocationForm=!0,e.showResourceLocation=!1,e.showResourceLocations=!1,e.showTransportationOptionsForm=!1,e.showResourceTypes=!1,!1},e.showTransportationDiv=function(){return e.$broadcast("show-errors-check-validity"),e.reslocform1.$invalid?void 0:(e.showLocationForm=!1,e.showResourceLocation=!1,e.showResourceLocations=!1,e.showTransportationOptionsForm=!0,e.showResourceTypes=!1,!1)},e.showLocationsDiv=function(){return e.showLocationForm=!1,e.showResourceLocation=!1,e.showResourceLocations=!0,e.showTransportationOptionsForm=!1,e.showResourceTypes=!1,!1},e.showResourceLocationDiv=function(){return e.showLocationForm=!1,e.showResourceLocations=!1,e.showResourceLocation=!0,e.showTransportationOptionsForm=!1,e.showResourceTypes=!1,!1},e.showResourceTypesDiv=function(){return e.showLocationForm=!1,e.showResourceLocations=!1,e.showResourceLocation=!1,e.showTransportationOptionsForm=!1,e.showResourceTypes=!0,!1},e.showTransport=function(t){return"Ground"==t?e.showGround:"Air"==t?e.showAir:"Water"==t?e.showWater:!1},e.showTransparentTransport=function(t){return"Ground"==t?!e.showGround:"Air"==t?!e.showAir:"Water"==t?!e.showWater:!1},e.toggleTransport=function(t){var o=e.transportTypes.map(function(e){return e.TransportTypeID}).indexOf(t),n=e.transportTypes[o];return"Ground"==n.Description?(e.showGround=!e.showGround,e.setTransportationType(t)):"Air"==n.Description?(e.showAir=!e.showAir,e.setTransportationType(t)):"Water"==n.Description&&(e.showWater=!e.showWater,e.setTransportationType(t)),!1},e.showResourceLocationInventoryEditForm=function(t){return e.currentResourceLocationInventory=t,e.resourceLocationInventoryEdit=!0,e.showResourceTypesDiv(),e.setResourceLocationInventoryType(t.ResourceType),!1},e.showResourceLocationInventoryNewForm=function(){e.resourceLocationInventoryEdit=!1,e.resourcesFiltered=!1,e.resourceTypesFiltered=e.resourceTypes;var t=new r;return t.ResourceLocationID=e.currentResourceLocation.ResourceLocationID,e.currentResourceLocationInventory=t,e.showResourceTypesDiv(),!1},e.setResourceLocationInventoryType=function(t){e.resourcesFiltered=!0,e.currentResourceLocationInventory.ResourceTypeID=t.ResourceTypeID,e.currentResourceLocationInventory.ResourceType=t,e.resourceTypesFiltered=e.resourceTypes.filter(function(e){return e.ResourceTypeID==t.ResourceTypeID}),e.resourceTypeUnitOfMeasuresFiltered=e.resourceTypeUnitOfMeasures.filter(function(e){return e.ResourceTypeID==t.ResourceTypeID});var o=e.currentResourceLocationInventory.ResourceTypeUnitOfMeasure;return o?e.setResourceTypeUnitOfMeasure(o):e.setResourceTypeUnitOfMeasure(e.resourceTypeUnitOfMeasuresFiltered[0]),!1},e.clearResourceTypeFiltered=function(){e.resourcesFiltered=!1,e.resourceTypesFiltered=e.resourceTypes},e.setResourceTypeUnitOfMeasure=function(t){e.currentResourceTypeUnitOfMeasure=t,e.currentResourceLocationInventory.ResourceTypeUnitOfMeasureID=t.ResourceTypeUnitOfMeasureID,e.currentResourceLocationInventory.ResourceTypeUnitOfMeasure=t},e.modalDeleteResourceLocationInventory=function(){e.modalInstance=s.open({templateUrl:"/inventory/resource-inventory-modal-delete.html",scope:e,size:"med"})},e.deleteResourceLocationInventory=function(){r["delete"]({id:e.currentResourceLocationInventory.ResourceLocationInventoryID}).$promise.then(function(t){var o=e.currentResourceLocation.ResourceLocationInventories.map(function(e){return e.ResourceLocationInventoryID}).indexOf(e.currentResourceLocationInventory.ResourceLocationInventoryID);e.currentResourceLocation.ResourceLocationInventories.splice(o,1),e.showResourceLocationDiv()})},e.modalDeleteResourceLocation=function(){e.modalInstance=s.open({templateUrl:"/inventory/resource-location-modal-delete.html",scope:e,size:"med"})},e.deleteResourceLocation=function(){n["delete"]({id:e.currentResourceLocation.ResourceLocationID}).$promise.then(function(t){var o=e.resourceLocations.map(function(e){return e.ResourceLocationID}).indexOf(e.currentResourceLocation.ResourceLocationID);e.resourceLocations.splice(o,1),e.currentResourceLocation=new n,e.showLocationsDiv(),m()})},e.saveResourceLocation=function(){return e.editMode?e.updateResourceLocation():e.saveNewResourceLocation(),!1},e.saveNewResourceLocation=function(){n.save(e.currentResourceLocation).$promise.then(function(e){c()})},e.updateResourceLocation=function(){n.update({id:e.currentResourceLocation.ResourceLocationID},e.currentResourceLocation).$promise.then(function(e){c()})},e.saveResourceLocationInventory=function(){return e.$broadcast("show-errors-check-validity"),e.reslocinvform.$invalid?void 0:(e.resourceLocationInventoryEdit?e.updateResourceLocationInventory():e.saveNewResourceLocationInventory(),!1)},e.saveNewResourceLocationInventory=function(){return r.save(e.currentResourceLocationInventory).$promise.then(function(t){e.currentResourceLocationInventory.ResourceSubtype=R(e.currentResourceLocationInventory.ResourceSubtypeID),e.currentResourceLocation.ResourceLocationInventories.push(e.currentResourceLocationInventory),e.showResourceLocationDiv()}),!1},e.updateResourceLocationInventory=function(){return r.update({id:e.currentResourceLocationInventory.ResourceLocationInventoryID},e.currentResourceLocationInventory).$promise.then(function(t){e.showResourceLocationDiv()}),!1},e.validateNumber=function(e){var t=e||window.event,o=t.keyCode||t.which;return!t.shiftKey&&!t.altKey&&!t.ctrlKey&&o>=48&&57>=o||8==o||9==o||13==o||37==o||39==o||46==o||45==o?!1:(t.returnValue=!1,t.preventDefault&&t.preventDefault(),!0)}}]),angular.module("helpNow").controller("LoginCtrl",["$scope","$http","$location","$routeParams","$resource",function(e,t,o,n,r){e.setCurrentView("login"),e.setTitle(e.text.login_title),e.validateUser=function(){void 0===e.userCreds.username||void 0===e.userCreds.password?alert("Missing Username or Password"):e.login()},e.login=function(){var n="username="+e.userCreds.username+"&password="+e.userCreds.password,r=t({method:"POST",url:"/authenticate/login",async:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:n});r.then(function(t){if(e.users=t.data.json,e.currentUser=e.users[0],void 0===e.currentUser)alert(e.text.incorrect_login_alert);else{
var n={AccountID:e.currentUser.AccountID,AccountRoleID:e.currentUser.AccountRoleID,FirstName:e.currentUser.FirstName,LastName:e.currentUser.LastName,OrganizationID:e.currentUser.Organization.OrganizationID,OrganizationTypeID:e.currentUser.Organization.OrganizationTypeID,OrganizationName:e.currentUser.Organization.Name};e.setCurrentUser(n),e.setCurrentOrg(e.currentUser.Organization),sessionStorage.setItem("user",JSON.stringify(n)),e.$broadcast("CurrentUserLoaded",{}),o.search("error",null),o.path("/")}},function(t){alert(e.text.incorrect_login_alert)})},e.checkForErrors=function(){var e=o.search().error;"undefined"!=typeof e&&e.indexOf("invalid_account")>=0&&alert("Your Facebook account has not been registered. Please register and try again.")},e.checkForErrors()}]),angular.module("helpNow").controller("ManageEventsCtrl",["$scope","$location","$resource","Event","$uibModal",function(e,t,o,n,r){function a(){angular.forEach(e.events,function(t){t.OrganizationID==e.currentOrg.OrganizationID&&e.orgEvents.push(t)}),e.orgEvents.length>0&&(e.noEvents=!1)}e.orgEvents=[],e.noEvents=!0,e.setTitle(e.text.manage_events_title),e.setCurrentView("manage_events"),a(),e.editEvent=function(e){t.path("/new_event/"+e.EventID)},e.disableEvent=function(o){var a=o;a.Active=0,e.modalInstance=r.open({templateUrl:"/manage/event-modal-delete.html",scope:e,controller:function(e){this.disabledEvent=a,this.Event=n,this.text=e.text,e.disableEvent=function(){n.update({id:a.EventID},a),t.path("/#"),e.loadEvents()}},controllerAs:"model"})}}]),angular.module("helpNow").controller("ManageMapLayersCtrl",["$scope","$location","$route","$resource","MapLayer","$uibModal",function(e,t,o,n,r,a){function i(){s.get({},function(t){e.mapLayers=t.json,angular.forEach(e.mapLayers,function(t){t.OrganizationID==e.currentOrg.OrganizationID&&1==t.MapLayerTypeID?e.orgBaseMaps.push(t):t.OrganizationID==e.currentOrg.OrganizationID&&2==t.MapLayerTypeID&&e.orgMapOverlays.push(t)}),e.orgBaseMaps.length>0&&(e.noBasemaps=!1),e.orgMapOverlays.length>0&&(e.noOverlays=!1)})}e.orgMapLayers=[],e.orgBaseMaps=[],e.orgMapOverlays=[],e.noBasemaps=!0,e.noOverlays=!0,e.setTitle(e.text.manage_map_layers_title),e.setCurrentView("manage_map_layers");var s=n("/api/maplayer/:id");i(),e.editMapLayer=function(e){null!=e.EventID&&e.EventID>0?t.path("/new_map_layer/"+e.EventID+"/"+e.MapLayerID):t.path("/new_map_layer/0/"+e.MapLayerID)},e.deleteMapLayer=function(t){var n=t;e.modalInstance=a.open({templateUrl:"/manage/map-layer-modal-delete.html",scope:e,controller:function(e){this.deletedMapLayer=n,this.MapLayer=r,this.text=e.text,e.deleteMapLayer=function(){s["delete"]({id:n.MapLayerID},function(e){o.reload()})}},controllerAs:"model"})}}]),angular.module("helpNow").controller("ManageCtrl",["$scope","$location","$resource","Invitation","$uibModal","Account",function(e,t,o,n,r,a){e.invitesResource=o("/api/inviterequest/organizationinvites/:accountid",{accountid:e.currentUser.AccountID}),e.orgResource=o("/api/organization/:id",{id:e.currentOrg.OrganizationID}),e.setTitle(e.text.manage_title_label),e.setCurrentView("mng"),e.loadInvites=function(){e.invitesResource.get({},function(t){e.invites=t.json,e.$broadcast("InviteDataLoaded",{})}),e.orgResource.get({},function(t){e.org=t.json[0],e.$broadcast("OrgLoaded",{})})},e.loadInvites(),e.deleteInvite=function(o){e.modalInstance=r.open({templateUrl:"/manage/invite-modal-delete.html",scope:e,controller:function(){this.invitation=o,this.Invitation=n,this.text=e.text,e.deleteInvite=function(e){n["delete"]({inviteid:e.InviteID}),t.path("/manage")}},controllerAs:"model"})},e.teamResource=o("/api/account/organizationmembers/:accountid",{accountid:e.currentUser.AccountID}),e.loadTeam=function(){e.teamResource.get({},function(t){e.team=t.json,e.$broadcast("TeamDataLoaded",{})})},e.loadTeam(),e.deleteTeamMember=function(o){e.modalInstance=r.open({templateUrl:"/manage/teammember-modal-delete.html",scope:e,controller:function(e){this.teamMember=o,this.Account=a,this.text=e.text,e.deleteMember=function(){a["delete"]({id:o.AccountID}),t.path("/manage")}},controllerAs:"model"})},e.enterAddress=function(){t.path("/org_address/"+e.currentOrg.OrganizationID)},e.editAPI=function(){t.path("/add_org/"+e.currentOrg.OrganizationTypeID+"/"+e.currentOrg.OrganizationID)},e.go=function(e){t.path(e)}}]),angular.module("helpNow").controller("NewEventCtrl",["$scope","$http","$location","$routeParams","$resource",function(e,t,o,n,r){function a(){e.eventTypesResource.get({},function(t){e.eventTypes=t.json,e.selectedEvent.selectedEventType=e.eventTypes[e.selectedEvent.selectedEventTypeID-1],e.selectedEvent.selectedEventTypeDescription=e.selectedEvent.selectedEventType.Description,e.getSelectedEventType()})}function i(){"Current"==e.locationPref.value?navigator.geolocation&&navigator.geolocation.getCurrentPosition(s):(l.removeLayer(e.locationOutline),e.newEvent.LAT="",e.newEvent.LONG="",e.$digest())}function s(t){e.newEvent.LAT=t.coords.latitude,e.newEvent.LONG=t.coords.longitude,void 0!==e.locationOutline&&l.removeLayer(e.locationOutline),e.locationOutline=L.circle([t.coords.latitude,t.coords.longitude],e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(l),e.$digest()}function c(){if(l&&e.events){for(var t=0;t<d.length;t++){var o=d[t];l.removeLayer(o)}d=[],e.showLocationMarkers&&e.buildLocationMarkers(e.locations,d,e.filterFlags),angular.forEach(d,function(e){l.addLayer(e)})}}function u(){e.eventID>0&&l&&(e.locationOutline=L.circle([e.newEvent.LAT,e.newEvent.LONG],e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(l))}var l,d=[];e.setCurrentView("new-event"),e.setTitle(e.text.new_event_title,"/style/images/New Emergency Event.png");var p=!1;e.eventID=1*n.eventID,e.events&&e.eventID>0?(p=!0,e.existingEvent=e.getEvent(e.eventID),e.newEvent=e.existingEvent,e.newEvent.LAT=e.existingEvent.EventLocations[0].LAT,e.newEvent.LONG=e.existingEvent.EventLocations[0].LONG,e.radiusRawVal=e.newEvent.EventLocations[0].Radius,e.overlayRadius=1e3*e.newEvent.EventLocations[0].Radius,e.sliderLabel=e.radiusRawVal+" km",e.selectedEvent={selectedEventTypeID:e.newEvent.EventTypeID},e.selectedEvent.selectedEventType=e.newEvent.EventType,e.selectedEvent.selectedEventTypeDescription=e.newEvent.EventType.Description,e.locationData=e.newEvent.EventLocations[0]):(p=!1,e.newEvent={Notes:"",Keywords:"",OrganizationID:e.currentOrg.OrganizationID,Active:"1",AreaSize:"15 km"},e.overlayRadius=15e3,e.radiusRawVal=15,e.sliderLabel="15 km",e.selectedEvent={selectedEventTypeID:"1"},e.locationData={Radius:""}),e.eventTypesResource=r("/api/eventtype/"),e.eventTypes=[],e.isMetric=!0,e.showEventDetails=!0,e.showContacts=!1,a(),e.getSelectedEventType=function(){e.newEvent.EventTypeID=e.selectedEvent.selectedEventType.EventTypeID},e.toggleNewEvent=function(){var t=!1;return e.showEventDetails&&((void 0===e.newEvent.LAT||""==e.newEvent.LAT||void 0===e.newEvent.LONG||""==e.newEvent.LONG)&&(t=!0),(void 0===e.newEvent.Summary||""==e.newEvent.Summary)&&(t=!0)),t?alert(e.text.missing_fields_alert):(e.showEventDetails=!e.showEventDetails,e.showContacts=!e.showContacts),!1},e.postNewEvent=function(){var o=JSON.stringify(e.newEvent),n=t({method:"POST",url:"/api/event",async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(t){e.locationData.EventID=t.data.json.EventID},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0}),n["finally"](function(t){void 0!==e.locationData.EventID&&""!=e.locationData.EventID&&e.postEventLocation()})},e.updateNewEvent=function(){var o=JSON.stringify(e.newEvent),n=t({method:"PUT",url:"/api/event/"+e.newEvent.EventID,async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(e){},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0}),n["finally"](function(t){void 0!==e.locationData.EventID&&""!=e.locationData.EventID&&e.updateEventLocation()})},e.postEventLocation=function(){var n=e.newEvent.AreaSize.split(" ");e.locationData.Radius=n[0],e.locationData.LAT=e.newEvent.LAT,e.locationData.LONG=e.newEvent.LONG,e.locationData.Description=e.newEvent.Summary;var r=JSON.stringify(e.locationData),a=t({method:"POST",url:"/api/eventlocation",async:!0,headers:{"Content-Type":"application/json"},data:r});a.then(function(t){o.path("#"),e.loadEvents()},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0})},e.updateEventLocation=function(){var n=e.newEvent.AreaSize.split(" ");e.locationData.Radius=n[0],e.locationData.LAT=e.newEvent.LAT,e.locationData.LONG=e.newEvent.LONG,e.locationData.Description=e.newEvent.Summary;var r=JSON.stringify(e.locationData),a=t({method:"PUT",url:"/api/eventlocation/"+e.locationData.EventLocationID,async:!0,headers:{"Content-Type":"application/json"},data:r});a.then(function(t){o.path("#"),e.loadEvents()},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0})},e.locationPref={value:"Other"},e.getLocation=function(){i()},e.centerMapToLongLat=function(e,t){l&&(l.setZoom(13),l.panTo(new L.LatLng(e,t)))},e.showValue=function(){0==e.radiusRawVal&&(e.radiusRawVal=15),e.isMetric?(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" km"):(e.overlayRadius=1e3*e.radiusRawVal,e.sliderLabel=e.radiusRawVal+" mi"),e.newEvent.AreaSize=e.sliderLabel,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)},e.changeUnits=function(){e.isMetric?(e.sliderLabel=e.radiusRawVal+" km",e.overlayRadius=e.overlayRadius/.62137119,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)):(e.sliderLabel=e.radiusRawVal+" mi",e.overlayRadius=.62137119*e.overlayRadius,void 0!==e.locationOutline&&e.locationOutline.setRadius(e.overlayRadius)),e.newEvent.AreaSize=e.sliderLabel},e.initMap=function(t){l=t,l.on("click",function(t){"Other"==e.locationPref.value&&(void 0!==e.locationOutline&&l.removeLayer(e.locationOutline),e.locationOutline=L.circle(t.latlng,e.overlayRadius,{color:"#00ff00",opacity:1,fillOpacity:.7}).addTo(l),e.newEvent.LAT=t.latlng.lat.toFixed(3),e.newEvent.LONG=t.latlng.lng.toFixed(3),e.$digest())}),c(),u()}}]),angular.module("helpNow").controller("NewMapLayerCtrl",["$scope","$http","$location","$routeParams","$resource",function(e,t,o,n,r){function a(){e.mapLayerTypeResource.get({},function(t){e.mapLayerTypes=t.json,e.selectedMapLayerType.selectedMapLayerType=e.mapLayerTypes[e.selectedMapLayerType.selectedMapLayerTypeID-1],e.selectedMapLayerType.selectedMapLayerTypeDescription=e.selectedMapLayerType.selectedMapLayerType.Description,e.getSelectedMapLayerType()})}function i(){e.mapLayerResource.get({id:e.mapLayerID},function(t){e.existingMapLayer=t.json,e.mapLayer=e.existingMapLayer[0],e.mapLayer.IsEsri?e.mapLayer.UsesEsri=!0:e.mapLayer.UsesEsri=!1,e.mapLayer.IsTSM?e.mapLayer.UsesTSM=!0:e.mapLayer.UsesTSM=!1,1==e.mapLayer.MapLayerTypeID?(e.mapLayer.MapLayerType="Base Map",e.selectedMapLayerType={selectedMapLayerTypeID:"1"}):2==e.mapLayer.MapLayerTypeID&&(e.mapLayer.MapLayerType="Map Overlay",e.selectedMapLayerType={selectedMapLayerTypeID:"2"})})}e.setCurrentView("new-map-layer"),e.eventID=1*n.eventID,e.mapLayerID=1*n.mapLayerID,e.mapLayerTypeResource=r("/api/maplayertype/"),e.mapLayerResource=r("/api/maplayer/:id");var s=!1;e.mapLayerID>0?(e.setTitle(e.text.btn_update_map_layer),s=!0,i()):(e.setTitle(e.text.btn_new_map_layer),s=!1,e.mapLayer={MapLayerType:"Base Map",UsesEsri:!1,UsesTSM:!1},e.selectedMapLayerType={selectedMapLayerTypeID:"1"}),a(),e.getSelectedMapLayerType=function(){e.mapLayer.MapLayerTypeID=e.selectedMapLayerType.selectedMapLayerType.MapLayerTypeID},e.submitNewMapLayer=function(){var t=!1;return(void 0===e.mapLayer.Name||""==e.mapLayer.Name||void 0===e.mapLayer.ImageryURL||""==e.mapLayer.ImageryURL||void 0===e.mapLayer.MinZoomLevel||""==e.mapLayer.MinZoomLevel||void 0===e.mapLayer.MaxZoomLevel||""==e.mapLayer.MaxZoomLevel)&&(t=!0),(void 0===e.mapLayer.MapLayerType||""==e.mapLayer.MapLayerType)&&(t=!0),e.mapLayer.UsesEsri?e.mapLayer.IsEsri=1:e.mapLayer.IsEsri=0,e.mapLayer.UsesTSM?e.mapLayer.IsTSM=1:e.mapLayer.IsTSM=0,e.eventID>0&&(e.mapLayer.EventID=e.eventID),e.mapLayer.OrganizationID=e.currentOrg.OrganizationID,t?alert(e.text.missing_fields_alert):e.postNewMapLayer(),!1},e.updateMapLayer=function(){var t=!1;return(void 0===e.mapLayer.Name||""==e.mapLayer.Name||void 0===e.mapLayer.ImageryURL||""==e.mapLayer.ImageryURL||void 0===e.mapLayer.MinZoomLevel||""==e.mapLayer.MinZoomLevel||void 0===e.mapLayer.MaxZoomLevel||""==e.mapLayer.MaxZoomLevel)&&(t=!0),(void 0===e.mapLayer.MapLayerType||""==e.mapLayer.MapLayerType)&&(t=!0),e.mapLayer.UsesEsri?e.mapLayer.IsEsri=1:e.mapLayer.IsEsri=0,e.mapLayer.UsesTSM?e.mapLayer.IsTSM=1:e.mapLayer.IsTSM=0,e.eventID>0&&(e.mapLayer.EventID=e.eventID),e.mapLayer.OrganizationID=e.currentOrg.OrganizationID,t?alert(e.text.missing_fields_alert):e.updateLayer(),!1},e.postNewMapLayer=function(){var n=JSON.stringify(e.mapLayer),r=t({method:"POST",url:"/api/maplayer",async:!0,headers:{"Content-Type":"application/json"},data:n});r.then(function(e){o.path("#")},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0})},e.updateLayer=function(){var n=JSON.stringify(e.mapLayer),r=t({method:"PUT",url:"/api/maplayer/"+e.mapLayer.MapLayerID,async:!0,headers:{"Content-Type":"application/json"},data:n});r.then(function(e){o.path("#")},function(t){alert("Error: "+t.data.err),e.hasSubmissionError=!0})}}]),angular.module("helpNow").controller("OrgAddressCtrl",["$scope","$http","$location","Organization","$routeParams","$resource",function(e,t,o,n,r,a){function i(){e.loadOrg()}function s(){var n=JSON.stringify(e.orgAddress),r=t({method:"PUT",url:"/api/address/"+e.org.AddressID,async:!0,headers:{"Content-Type":"application/json"},data:n});r.then(function(e){alert("Address Successfully Submitted"),o.path("#")},function(e){})}function c(){var o=JSON.stringify(e.orgAddress),n=t({method:"POST",url:"/api/address",async:!0,headers:{"Content-Type":"application/json"},data:o});n.then(function(e){alert("Address Successfully Submitted"),u(e.data.json.AddressID)},function(e){alert("Error: ")})}function u(n){e.org.AddressID=n;var r=JSON.stringify(e.org),a=t({method:"PUT",url:"/api/organization/"+e.org.OrganizationID,async:!0,headers:{"Content-Type":"application/json"},data:r});a.then(function(e){o.path("#/manage")},function(e){})}e.setCurrentView("org-address"),e.setTitle(e.text.address_title),e.addressResource=a("/api/address/:id"),e.orgResource=a("/api/organization/:id"),e.orgID=1*r.orgID,e.loadOrg=function(){e.orgResource.get({id:e.orgID},function(t){e.org=t.json[0],e.loadAddress()})},e.loadAddress=function(){e.org.AddressID&&e.addressResource.get({id:e.org.AddressID},function(t){e.orgAddress=t.json[0],t.json[0]&&(e.hasAddress=!0)})},i(),e.submitOrgAddress=function(){e.hasAddress?s():c()}}]),angular.module("helpNow").controller("OrgEventCtrl",["$scope","$routeParams","$resource","$sce","$location","$http",function(e,t,o,n,r,a){function i(){e.showFilters=!1,e.showFindPanel=!1,e.showFindResults=!1,e.showMappingError=!1,e.showDeployPanel=!1,e.showDeploymentPanel=!1,e.showBlockagePanel=!1}function s(){"Current"==e.locationPref.value?navigator.geolocation&&navigator.geolocation.getCurrentPosition(c):(e.mappingLoc.LAT=null,e.mappingLoc.LONG=null,l())}function c(t){e.mappingLoc.LAT=t.coords.latitude,e.mappingLoc.LONG=t.coords.longitude,l(),e.$digest()}function u(){e.locationOutline&&N.removeLayer(e.locationOutline)}function l(){u();var t={color:"#00ff00",opacity:1,fillOpacity:.7,radius:15};e.showFindPanel&&e.mappingLoc.LAT&&e.mappingLoc.LONG?e.locationOutline=L.circleMarker([e.mappingLoc.LAT,e.mappingLoc.LONG],t).addTo(N):e.showDeployPanel&&e.deployment.LAT&&e.deployment.LONG?e.locationOutline=L.circleMarker([e.deployment.LAT,e.deployment.LONG],t).addTo(N):e.showBlockagePanel&&e.blockage.LAT&&e.blockage.LONG&&(e.locationOutline=L.circleMarker([e.blockage.LAT,e.blockage.LONG],t).addTo(N))}function d(e){return"Water"==e?"style/images/markers/dot-blue.png":"First Aid"==e?"style/images/markers/dot-red.png":"Shelter"==e?"style/images/markers/dot-orange.png":"Evacuation"==e?"style/images/markers/dot-purple.png":"Medicine"==e?"style/images/markers/dot-cyan.png":"Clothing"==e?"style/images/markers/dot-yellow.png":"Rescue"==e?"style/images/markers/dot-magenta.png":"style/images/markers/dot-green.png"}function p(e){return"Water"==e?"style/images/Water-Circle-Red.png":"First Aid"==e?"style/images/First Aid-Circle-Red.png":"Shelter"==e?"style/images/Shelter-Circle-Red.png":"Clothing"==e?"style/images/Clothing-Circle-Red.png":"Rescue"==e?"style/images/Rescue-Circle-Red.png":"Evacuation"==e?"style/images/Evacuation-Circle-Red.png":"Medicine"==e?"style/images/Medicine-Circle-Red.png":"style/images/Food-Circle-Red.png"}function g(e){angular.forEach(e,function(e){var t=L.icon({iconUrl:d(e.ResourceType.Description),iconSize:[27,27],iconAnchor:[13,41],popupAnchor:[0,-45]}),o=L.marker([e.LAT,e.LONG],{icon:t});o.bindPopup("<strong>"+e.ResourceType.Description+" ("+e.Quantity+")</strong><br/>"+e.Notes),C.push(o)})}function m(){e.requestClusters&&(e.selectedClusters=e.requestClusters.filter(function(t){var o=t.ResourceType.Description;return e.shouldDisplayMarker(o,e.filterFlags)}),angular.forEach(e.selectedClusters,function(e){var t=L.icon({iconUrl:p(e.ResourceType.Description),iconSize:[50,50],iconAnchor:[25,25]}),o=L.marker([e.LAT,e.LONG],{icon:t});o.bindPopup("<strong>"+e.ResourceType.Description+"</strong><br/>"+e.Notes),C.push(o)}))}function h(){angular.forEach(e.locations,function(t){angular.forEach(t.ResourceLocationInventories,function(o){angular.forEach(e.requests,function(e){e.fulfilled||(e.fulfilled=E(t.LAT,t.LONG,e.LAT,e.LONG)<4&&e.ResourceTypeID==o.ResourceTypeID)})})})}function v(e){var t={radius:.1,maxOpacity:.5,scaleRadius:!0,useLocalExtrema:!0,latField:"LAT",lngField:"LONG",valueField:"Quantity"},o=new HeatmapOverlay(t),n={data:e};o.setData(n),C.push(o)}function f(){if(e.distributionCenters){var t=e.distributionCenters.filter(function(t){return e.shouldDisplayLocationMarker(t,e.filterFlags)});angular.forEach(t,function(t){var o=t.OrganizationID==e.currentOrg.OrganizationID,n=o?"style/images/Distribution-Center-DBox-Blue.png":"style/images/Distribution-Center-Box-Blue.png",r=L.icon({iconUrl:n,iconSize:[60,60],iconAnchor:[30,30]}),a=e.buildLocationMarker(t,r);C.push(a)})}}function y(){e.blockages&&angular.forEach(e.blockages,function(t){var o="style/images/Alert.png",n=L.icon({iconUrl:o,iconSize:[30,30],iconAnchor:[15,15]}),r=L.marker([t.LAT,t.LONG],{icon:n});r.on("click",function(){e.$apply(function(){I(t)})}),C.push(r)})}function w(){angular.forEach(e.matches,function(e,t){var o=L.polyline(e.Route,{color:b[t]});C.push(o)})}function R(){if(N&&e.events){for(var t=N.getZoom(),o=0;o<C.length;o++){var n=C[o];N.removeLayer(n)}C=[],h();var r=e.requests.filter(function(t){if(t.fulfilled)return!1;var o=t.ResourceType.Description;return e.shouldDisplayMarker(o,e.filterFlags)});e.showHeatmap&&e.selectedClusters.length>0&&v(e.selectedClusters),e.showNeedsMarkers&&t>7&&g(r),e.showClusters&&m(),e.showLocationMarkers&&e.buildLocationMarkers(e.locations,C,e.filterFlags,D),e.showDistCenterMarkers&&f(),e.showBlockageMarkers&&y(),e.showFindResults&&e.matches&&w(),angular.forEach(C,function(e){N.addLayer(e)})}}function D(t){i(),e.deployment=t,e.showDeploymentPanel=!0}function I(t){i(),e.blockage=t,e.showBlockageDetailPanel=!0}function T(){e.requestsResource.get({eventID:e.eventID},function(t){var o=t.json.requests.length!=e.requests.length||t.json.locations.length!=e.locations.length||t.json.distributionCenters.length!=e.distributionCenters.length||t.json.blockages.length!=e.blockages.length;o&&(e.requestClusters=t.json.requestClusters,e.requests=t.json.requests,e.locations=t.json.locations,e.distributionCenters=t.json.distributionCenters,e.blockages=t.json.blockages,R())})}function O(e){return e*(Math.PI/180)}function E(e,t,o,n){var r=6371,a=O(o-e),i=O(n-t),s=Math.sin(a/2)*Math.sin(a/2)+Math.cos(O(e))*Math.cos(O(o))*Math.sin(i/2)*Math.sin(i/2),c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return r*c}function M(){var t=e.matchingFlags,o=[];return t.showFood&&o.push("Food"),t.showWater&&o.push("Water"),t.showShelter&&o.push("Shelter"),t.showClothing&&o.push("Clothing"),t.showRescue&&o.push("Rescue"),t.showEvacuation&&o.push("Evacuation"),t.showMedical&&o.push("First+Aid"),t.showMedicine&&o.push("Medicine"),o.join(",")}var N,C=[],b=["#fcff00","#ff00e4","#00ffc6"];e.setCurrentView("events"),e.requestsResource=o("/api/event/mapitems/:eventID"),e.matchingResource=o("/api/resourcelocation/dist-center/nearest/:loc?resources=:resources"),e.BlockageResource=o("/api/blockage/:id"),e.eventID=1*t.eventID,e.events&&(e.event=e.getEvent(e.eventID),e.setTitle(e.event.EventLocations[0].Description,e.getEventIcon(e.event.EventType.Description)),T());var S=setInterval(T,1e4);e.$on("$destroy",function(){clearInterval(S)}),e.requests=[],e.locations=[],e.distributionCenters=[],e.blockages=[],e.selectedClusters=[],e.showFilters=!1,e.showFindPanel=!1,e.showFindResults=!1,e.showMappingError=!1,e.showDeployPanel=!1,e.showDeploymentPanel=!1,e.showBlockagePanel=!1;var $=JSON.parse(sessionStorage.getItem("showHeatmap")),A=JSON.parse(sessionStorage.getItem("showClusters")),F=JSON.parse(sessionStorage.getItem("showNeedsMarkers")),U=JSON.parse(sessionStorage.getItem("showLocationMarkers")),P=JSON.parse(sessionStorage.getItem("showDistCenterMarkers")),k=JSON.parse(sessionStorage.getItem("showBlockageMarkers"));null!=$?e.showHeatmap=$:e.showHeatmap=!0,null!=A?e.showClusters=A:e.showClusters=!0,null!=F?e.showNeedsMarkers=F:e.showNeedsMarkers=!1,null!=U?e.showLocationMarkers=U:e.showLocationMarkers=!0,null!=P?e.showDistCenterMarkers=P:e.showDistCenterMarkers=!1,null!=k?e.showBlockageMarkers=k:e.showBlockageMarkers=!0;var z=JSON.parse(sessionStorage.getItem("filterFlags"));null!=z?e.filterFlags=JSON.parse(sessionStorage.getItem("filterFlags")):e.filterFlags={showMedical:!0,showShelter:!0,showFood:!0,showWater:!0,showClothing:!0,showRescue:!0,showEvacuation:!0,showMedicine:!0},e.matchingFlags={showMedical:!1,showShelter:!1,showFood:!1,showWater:!1,showClothing:!1,showRescue:!1,showEvacuation:!1,showMedicine:!1},e.mappingLoc={},e.deployment={},e.blockage={EventID:e.eventID},e.locationPref={value:"Current"},e.getLocation=function(){s()},e.getMatchResources=function(){var t=[],o=e.matchingFlags;return o.showMedical&&t.push("First Aid"),o.showShelter&&t.push("Shelter"),o.showFood&&t.push("Food"),o.showWater&&t.push("Water"),o.showClothing&&t.push("Clothing"),o.showRescue&&t.push("Rescue"),o.showEvacuation&&t.push("Evacuation"),o.showMedicine&&t.push("Medicine"),t.join(", ")},e.$on("EventDataLoaded",function(){e.event=e.getEvent(e.eventID),e.setTitle(e.event.EventLocations[0].Description,e.getEventIcon(e.event.EventType.Description)),T(),R()}),e.getRouteColor=function(e){return b[e]},e.toggleHelp=function(){r.path("request_help/"+e.eventID)},e.centerMapToLongLat=function(e,t){N&&(N.setZoom(13),N.panTo(new L.LatLng(e,t)))},e.toggleButtonClass=function(t){var o=e[t];return o?"btn btn-toggle active":"btn btn-toggle"},e.toggleButton=function(t){return e[t]=!e[t],R(),!1},e.toggleResourceFilter=function(t){var o=e.filterFlags;return o[t]=!o[t],R(),!1},e.toggleResourceButtonClass=function(t){var o=e.filterFlags,n=o[t];return R(),n?"btn btn-toggle active":"btn btn-toggle"},e.toggleMatchingFilter=function(t){var o=e.matchingFlags;return o[t]=!o[t],R(),!1},e.toggleMatchingButtonClass=function(t){var o=e.matchingFlags,n=o[t];return n?"btn btn-toggle active":"btn btn-toggle"},e.getCleanLocationText=function(t){return n.trustAsHtml(e.buildLocationDetails(t))},e.initMap=function(t){N=t,N.on("zoomend",function(){R()}),N.on("click",function(t){e.showFindPanel&&!e.showFindResults?(e.locationPref.value="Other",e.mappingLoc.LAT=t.latlng.lat.toFixed(3),e.mappingLoc.LONG=t.latlng.lng.toFixed(3),l(),e.$digest()):e.showDeployPanel?(e.deployment.LAT=t.latlng.lat.toFixed(3),e.deployment.LONG=t.latlng.lng.toFixed(3),l(),e.$digest()):e.showBlockagePanel&&(e.blockage.LAT=t.latlng.lat.toFixed(3),e.blockage.LONG=t.latlng.lng.toFixed(3),l(),e.$digest())}),R()},e.filterButtonText=function(){return e.showFilters?"Hide":"Show"},e.toggleFilters=function(){var t={showMedical:e.filterFlags.showMedical,showShelter:e.filterFlags.showShelter,showFood:e.filterFlags.showFood,showWater:e.filterFlags.showWater,showClothing:e.filterFlags.showClothing,showRescue:e.filterFlags.showRescue,showEvacuation:e.filterFlags.showEvacuation,showMedicine:e.filterFlags.showMedicine};sessionStorage.setItem("showNeedsMarkers",JSON.stringify(e.showNeedsMarkers)),sessionStorage.setItem("showLocationMarkers",JSON.stringify(e.showLocationMarkers)),sessionStorage.setItem("showDistCenterMarkers",JSON.stringify(e.showDistCenterMarkers)),sessionStorage.setItem("showClusters",JSON.stringify(e.showClusters)),sessionStorage.setItem("showHeatmap",JSON.stringify(e.showHeatmap)),sessionStorage.setItem("filterFlags",JSON.stringify(t)),e.showFilters=!e.showFilters},e.toggleFindPanel=function(){e.showFindPanel=!e.showFindPanel,e.showFindPanel?(e.showDistCenterMarkers=!0,s()):(u(),e.showFindResults=!1,delete e.matches),R()},e.toggleDeployPanel=function(){e.showDeployPanel=!e.showDeployPanel,e.showDeployPanel&&(s(),e.showDistCenterMarkers=!0,R())},e.toggleBlockagePanel=function(){e.showBlockagePanel=!e.showBlockagePanel,e.showBlockagePanel?(e.blockage={EventID:e.eventID},s()):u()},e.findMatches=function(){if(e.showMappingError=!1,!e.mappingLoc.LAT||!e.mappingLoc.LONG||0==e.getMatchResources().length)return e.showMappingError=!0,!1;var t=e.mappingLoc.LAT+","+e.mappingLoc.LONG,o=M();return e.matchingResource.get({loc:t,resources:o},function(t){e.matches=t.json,e.hasMatches=e.matches.length>0,console.log(e.matches[0]),e.showFindResults=!0,R()}),!1},e.showLocation=function(e,t){N.setView([e,t],N.getZoom()),R()},e.backToFind=function(){return delete e.matches,e.showFindResults=!1,R(),!1},e.closeDeploymentPanel=function(){e.showDeploymentPanel=!1},e.closeBlockageDetailPanel=function(){e.showBlockageDetailPanel=!1},e.panelIsOpen=function(){return e.showFindPanel||e.showFilters||e.showDeployPanel||e.showDeploymentPanel||e.showBlockagePanel||e.showBlockageDetailPanel},e.createDeployment=function(){"Current"==e.locationPref.value&&(e.deployment.LAT=e.mappingLoc.LAT,e.deployment.LONG=e.mappingLoc.LONG);var t="create_deployment/"+e.eventID+"/"+e.deployment.LAT+"/"+e.deployment.LONG;r.path(t)},e.modifyDeployment=function(){var t="modify_deployment/"+e.deployment.ResourceLocationID;r.path(t)},e.removeBlockage=function(){e.BlockageResource["delete"]({id:e.blockage.BlockageID}),e.closeBlockageDetailPanel()},e.reportBlockage=function(){if("Current"==e.locationPref.value)e.blockage.LAT=e.mappingLoc.LAT,e.blockage.LONG=e.mappingLoc.LONG;else if(!e.blockage.LAT||!e.blockage.LAT)return;var t=new e.BlockageResource(e.blockage);t.$save().then(function(t){e.toggleBlockagePanel()})["catch"](function(e){alert(e.data.err)})},e.setCurrentView("org-event")}]),angular.module("helpNow").controller("OrganizationAddCtrl",["$scope","$resource","$routeParams","Organization","$location",function(e,t,o,n,r){function a(){e.isNew||e.loadOrg()}e.orgTypeID=1*o.orgTypeID,e.newOrg=new n,e.newOrg.OrganizationTypeID=e.orgTypeID,e.newOrg.CreateDate=new Date,e.orgType=1==e.orgTypeID?e.text.gov_name_label:e.text.org_name_label,e.orgResource=t("/api/organization/:id"),e.orgID=1*o.orgID,0==e.orgID&&(e.isNew=!0),e.loadOrg=function(){e.orgResource.get({id:e.orgID},function(t){e.org=t.json[0],null!=e.org.Name&&(e.newOrg.Name=e.org.Name)})},a(),e.setTitle(e.text.create+" "+e.orgType),e.go=function(e){r.path(e)},e.addOrg=function(t){return void 0===t.Name||null==t.Name||void 0===t.APISecret||null==t.APISecret?void alert(e.text.missing_fields_alert):void(e.isNew?n.save(t).$promise.then(function(e){r.path("/administration")},function(e){alert("Error: "+e.data.err)}):n.update({id:e.orgID},t).$promise.then(function(e){r.path("/administration")},function(e){alert("Error: "+e.data.err)}))},e.enterAddress=function(t){return void 0===t.Name||null==t.Name||void 0===t.APISecret||null==t.APISecret?void alert(e.text.missing_fields_alert):void n.save(t).$promise.then(function(e){var t=e.json[0];r.path("/org_address/"+t.OrganizationID)},function(e){alert("Error: "+e.data.err)})}}]),angular.module("helpNow").controller("PasswordResetCtrl",["$scope","$http","Account","$location","$routeParams","$resource",function(e,t,o,n,r,a){function i(){e.accountResource.get({id:e.accountID},function(t){e.account=t.json,null==e.account&&alert("Account could not be found")})}e.setCurrentView("password_reset"),e.setTitle(e.text.reset_password_title),e.accountID=1*r.accountID,e.guid=r.guid,e.showOldPasswordField=0==e.guid?!0:!1,e.accountResource=a("/api/account/:id"),e.inviteRequestResource=a("/api/inviterequest/passwordupdate/"),0==e.guid&&i(),e.updatePassword=function(){if(e.newPassword===e.confirmedPassword)if(0==e.guid)e.account[0].Password=e.newPassword,o.update({id:e.accountID},JSON.stringify(e.account[0])).$promise.then(function(e){n.path("#")},function(e){alert("Error: "+e.data.err)});else{var r="Password="+e.newPassword+"&InviteRequestID="+e.guid,a=t({method:"POST",url:"/api/inviterequest/passwordupdate",async:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:r});a.then(function(e){0!=e.data.json?n.path("#"):alert("Error: "+e.data.err)})}else alert("Passwords do not match.")}}]),angular.module("helpNow").controller("RegAccountCtrl",["$scope","$http","$location","Invitation","$routeParams","$resource",function(e,t,o,n,r,a){function i(){e.inviteResource.get({inviteid:e.inviteid},function(t){e.inviteRequest=t.json,null==e.inviteRequest||null==e.inviteRequest[0]||e.inviteRequest[0].OrganizationID<=0?(alert("Invitation information could not be found.  Contact your organization's administrator for a new invitation."),o.path("#")):(e.userAccount.OrganizationID=e.inviteRequest[0].OrganizationID,e.userAccount.FirstName=e.inviteRequest[0].FirstName,e.userAccount.LastName=e.inviteRequest[0].LastName,e.userAccount.Email=e.inviteRequest[0].Email)})}function s(){var r=JSON.stringify(e.userAccount),a=t({method:"POST",url:"/api/account",async:!0,headers:{"Content-Type":"application/json"},data:r});a.then(function(t){alert("Account Successfully Created"),n["delete"]({inviteid:e.inviteid}),o.path("#")},function(e){alert("Error: ")})}e.setCurrentView("reg-account"),e.setTitle(e.text.reg_account_title),e.showUsername=!0,e.showUser=!1,e.inviteid=r.inviteID,e.inviteResource=a("/api/inviteRequest/:inviteid"),e.userAccount={Active:!0,AccountRoleID:2,CreateDate:new Date,IsHashed:0},i(),e.showUserForm=function(){var t=!1;void 0===e.userAccount.Username||void 0===e.userAccount.Password||void 0===e.confirmedPassword?(alert(e.text.missing_fields_alert),t=!0):e.userAccount.Password!=e.confirmedPassword&&(alert(e.text.password_mismatch_alert),t=!0),t||(e.showUser=!0,e.showUsername=!1)},e.showUsernameForm=function(){e.showUser=!1,e.showUsername=!0},e.submitUserReg=function(){var t=!1;(void 0===e.userAccount.FirstName||void 0===e.userAccount.LastName||void 0===e.userAccount.Email)&&(alert(e.text.missing_fields_alert),t=!0),t||s()}}]),angular.module("helpNow").controller("RegulationAddCtrl",["$scope","$resource","$routeParams","Regulation","$location",function(e,t,o,n,r){e.newReg=new n,e.newReg.OrganizationID=e.currentOrg.OrganizationID,e.go=function(e){r.path(e)},e.addRegulation=function(e){console.log(e.Narrative),console.log(e.Summary),n.save(e),r.path("/regulations")}}]),angular.module("helpNow").controller("RegulationDetailCtrl",["$scope","$resource","$routeParams","Regulation","$location",function(e,t,o,n,r){e.regulationResource=n.get({id:o.organizationRegulationsID},function(t){e.regulation=t.json,e.$broadcast("RegulationDataLoaded",{})}),e.go=function(e){r.path(e)}}]),angular.module("helpNow").controller("RegulationEditCtrl",["$scope","$resource","$routeParams","Regulation","$location","$uibModal",function(e,t,o,n,r,a){e.regulationResource=n.get({
id:o.organizationRegulationsID},function(t){e.editRegulations=t.json,e.editReg=e.editRegulations[0],e.$broadcast("RegulationDataLoaded",{})}),e.updateRegulation=function(e){n.update({id:o.organizationRegulationsID},e),r.path("/regulations")},e.deleteRegulation=function(t){e.modalInstance=a.open({templateUrl:"/manage/regulations-modal-delete.html",scope:e,controller:function(e){this.regulation=t,this.Regulation=n,this.text=e.text,e.deleteReg=function(){console.log("regulation.OrganizationRegulationsID"+t.OrganizationRegulationsID),n["delete"]({id:t.OrganizationRegulationsID}),r.path("/regulations")}},controllerAs:"model"})},e.go=function(e){r.path(e)}}]),angular.module("helpNow").controller("RegulationsCtrl",["$scope","$resource","$location",function(e,t,o){e.regulationsResource=t("api/organizationregulation/account/:accountId",{accountId:e.currentUser.AccountID}),e.loadRegulations=function(){e.regulationsResource.get({},function(t){e.regulations=t.json,e.$broadcast("RegulationDataLoaded",{})})},e.loadRegulations(),e.setCurrentView("regulations"),e.$on("RegulationDataLoaded",function(){}),e.go=function(e){o.path(e)}}]),angular.module("helpNow").controller("RootCtrl",["$scope","$route","$location","$http","$resource",function(e,t,o,n,r){var a="Eng",i="";e.eventsResource=r("/api/event"),e.currentUser=JSON.parse(sessionStorage.getItem("user")),null!=e.currentUser&&(1==e.currentUser.AccountRoleID?e.isSuperAdmin=!0:e.isSuperAdmin=!1),e.currentOrg=JSON.parse(sessionStorage.getItem("user")),e.loadEvents=function(){e.eventsResource.get({},function(t){e.events=t.json,e.$broadcast("EventDataLoaded",{})})},e.getShowLogin=function(){return e.title?0==e.title.indexOf(e.text.login_title)?!1:e.currentUser?!1:!0:!0},e.getEventIcon=function(e){return"Flood"==e?"style/images/flood.png":"Tsunami"==e?"style/images/Tsunami.png":"style/images/earthquake.png"},e.getMenuClass=function(e){return e==i?"active":""},e.setCurrentView=function(e){i=e},e.setTitle=function(t,o){e.title=t,e.imageSrc=o},e.setCurrentUser=function(t){e.currentUser=t,1==e.currentUser.AccountRoleID?e.isSuperAdmin=!0:e.isSuperAdmin=!1},e.getCurrentUser=function(){return e.currentUser},e.setCurrentOrg=function(t){e.currentOrg=t},e.setCurrentLanguage=function(o){a=o,"Ben"==o?n.get("i18n/text-BEN.json").success(function(o){e.text=o,t.reload()}).error(function(e){console.log("setCurrentLanguage: "+e)}):"Fre"==o?n.get("i18n/text-FRE.json").success(function(o){e.text=o,t.reload()}).error(function(e){console.log("setCurrentLanguage: "+e)}):"Esp"==o?n.get("i18n/text-ESP.json").success(function(o){e.text=o,t.reload()}).error(function(e){console.log("setCurrentLanguage: "+e)}):n.get("i18n/text-ENG.json").success(function(o){e.text=o,t.reload()}).error(function(e){console.log("setCurrentLanguage: "+e)})},e.getCurrentLanguage=function(){e.currentLanguage=a},e.getLanguageClass=function(e){return a==e?"active":""},e.setCurrentLanguage("Eng"),e.getResourcesForEvent=function(t){for(var o=[],n=0;n<e.resources.length;n++){var r=e.resources[n];r.eventID==t&&o.push(r)}return o.length>0?o:{}},e.getEvent=function(t){for(var o=0;o<e.events.length;o++){var n=e.events[o];if(n.EventID==t)return n}return{}},e.getLocationIcon=function(t){var o=t.ResourceLocationInventories,n=e.currentOrg&&t.OrganizationID==e.currentOrg.OrganizationID;if(o.length>1)return n?"style/images/Resources-DBox-Blue.png":"style/images/Resources-Box-Blue.png";var r=n?"DDiamond-Blue":"Diamond-Blue",a=o[0].ResourceType.Description;return"Water"==a?"style/images/Water-"+r+".png":"First Aid"==a?"style/images/First Aid-"+r+".png":"Shelter"==a?"style/images/Shelter-"+r+".png":"Evacuation"==a?"style/images/Evacuation-"+r+".png":"Clothing"==a?"style/images/Clothing-"+r+".png":"Rescue"==a?"style/images/Rescue-"+r+".png":"Medicine"==a?"style/images/Medicine-"+r+".png":"style/images/Food-"+r+".png"},e.getResourceName=function(e){var t=e.ResourceType.Description;return e.ResourceSubtype&&(t+=" ("+e.ResourceSubtype.Description+")"),t},e.buildLocationDetails=function(t){var o="<strong>"+t.Organization.Name+"</strong><br/>"+t.PrimaryPOCName+"<br/>"+t.PrimaryPOCPhone+"<hr/>";return t.ResourceLocationInventories.forEach(function(t){o+="<strong>"+e.getResourceName(t)+":</strong> "+t.Quantity+" "+t.ResourceTypeUnitOfMeasure.Description+"<br/>"}),o},e.buildLocationMarker=function(t,o,n){var r=L.marker([t.LAT,t.LONG],{icon:o});return n?r.on("click",function(){e.$apply(function(){n(t)})}):r.bindPopup(e.buildLocationDetails(t)),r},e.buildLocationMarkers=function(t,o,n,r){if(t){var a=t.filter(function(t){return e.shouldDisplayLocationMarker(t,n)});angular.forEach(a,function(t){var n=L.icon({iconUrl:e.getLocationIcon(t),iconSize:[60,60],iconAnchor:[30,30]}),a=e.buildLocationMarker(t,n,r);o.push(a)})}},e.shouldDisplayMarker=function(e,t){return"Water"==e&&t.showWater||"Shelter"==e&&t.showShelter||"Food"==e&&t.showFood||"Clothing"==e&&t.showClothing||"Rescue"==e&&t.showRescue||"Evacuation"==e&&t.showEvacuation||"First Aid"==e&&t.showMedical||"Medicine"==e&&t.showMedicine},e.shouldDisplayLocationMarker=function(t,o){for(var n=t.ResourceLocationInventories,r=0;r<n.length;r++)if(e.shouldDisplayMarker(n[r].ResourceType.Description,o))return!0;return!1},e.loadEvents(),e.$on("$locationChangeSuccess",function(t,o,r){var a="_=_";if(o.indexOf(a)>0&&r.indexOf(a)>0){var i=n({method:"POST",url:"/auth/account",async:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}});i.then(function(t){if(e.users=t.data.json,e.currentUser=e.users[0],void 0===e.currentUser)alert(e.text.incorrect_login_alert);else{var o={AccountID:e.currentUser.AccountID,FirstName:e.currentUser.FirstName,LastName:e.currentUser.LastName,OrganizationID:e.currentUser.Organization.OrganizationID,OrganizationTypeID:e.currentUser.Organization.OrganizationTypeID,OrganizationName:e.currentUser.Organization.Name};e.setCurrentUser(o),e.setCurrentOrg(e.currentUser.Organization),sessionStorage.setItem("user",JSON.stringify(o)),e.$broadcast("CurrentUserLoaded",{})}},function(t){alert(e.text.incorrect_login_alert)})}}),e.redirectToLogin=function(){o.path("/login")},e.redirectToLogout=function(){e.currentUser=!1,e.isSuperAdmin=!1,sessionStorage.removeItem("user");var t=n({method:"POST",url:"/authenticate/logout",async:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"}});t.then(function(e){},function(e){alert("Logout Error - "+e)}),o.path("#")},e.resources=[{id:1,eventID:1,resourceType:"First Aid",lat:23.718,"long":90.355,provider:"NGO #1",message:""},{id:2,eventID:1,resourceType:"First Aid",lat:23.719,"long":90.374,provider:"NGO #2",message:""},{id:3,eventID:1,resourceType:"First Aid",lat:23.765,"long":90.398,provider:"NGO #3",message:""},{id:4,eventID:1,resourceType:"Water",lat:23.767,"long":90.41,provider:"NGO #4",message:""},{id:5,eventID:1,resourceType:"Evacuation Site",lat:23.73,"long":90.365,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."},{id:6,eventID:1,resourceType:"Evacuation Site",lat:23.75,"long":90.43,provider:"",message:"No more than 1 bag per person.  Only bring what you can carry."}]}]),angular.module("helpNow").controller("TeamInviteCtrl",["$scope","$resource","$routeParams","Invitation","$http","$location","$uibModal",function(e,t,o,n,r,a,i){e.newInvite=new n,e.newInvite.OrganizationID=e.currentOrg.OrganizationID,e.sendInvite=function(t){n.save(t,function(o){o.json?(e.confirmEmail(t),console.log("email success")):(e.confirmEmailError(),conole.log("email failed"))})},e.confirmEmail=function(t){e.modalInstance=i.open({templateUrl:"/manage/team-invite-modal-confirm.html",scope:e,controller:function(e){this.invitation=t,this.text=e.text,e.confirm=function(){a.path("/manage")}},controllerAs:"model"})},e.confirmEmailError=function(){e.modalInstance=i.open({templateUrl:"/manage/team-invite-modal-error.html",scope:e,controller:function(e){e.confirm=function(){a.path("/manage")}},controllerAs:"model"})},e.go=function(e){a.path(e)}}]),angular.module("helpNow").controller("TomnodCtrl",["$scope","$location","$resource","Event","$uibModal",function(e,t,o,n,r){e.orgEvents=[],e.noEvents=!0,e.setTitle(e.text.tomnod_title),e.setCurrentView("manage_events"),$.each(e.events,function(e,t){$("#event").append($("<option/>").attr("value",t.EventID).text(t.EventType.Description+" "+t.Summary+" ("+t.EventLocations[0].LAT+", "+t.EventLocations[0].LONG+", "+t.EventLocations[0].Radius+" km2)"))})}]),angular.module("helpNow").directive("showErrors",function(){return{restrict:"A",require:"^form",link:function(e,t,o,n){var r=t[0].querySelector("[name]"),a=angular.element(r),i=a.attr("name");a.bind("blur",function(){t.toggleClass("has-error",n[i].$invalid)}),e.$on("show-errors-check-validity",function(){t.toggleClass("has-error",n[i].$invalid)})}}}),angular.module("helpNow").directive("latitude",function(){var e=/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)/i;return{require:"ngModel",link:function(t,o,n,r){r.$validators.latitude=function(t,o){return r.$isEmpty(o)?!0:e.test(o)}}}}),angular.module("helpNow").directive("longitude",function(){var e=/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/i;return{require:"ngModel",link:function(t,o,n,r){r.$validators.longitude=function(t,o){return r.$isEmpty(o)?!0:e.test(o)}}}}),angular.module("helpNow").directive("filters",function(){return{scope:{togglefunc:"=",classfunc:"="},templateUrl:"views/fragments/resource-filters.html"}}),angular.module("helpNow").directive("map",["MapLayer",function(e){return{link:function(t,o,n){var r=n.mapCenter.split(","),a=n.mapZoom,i=n.mapEvent;e.get({},function(e){for(var o,n,s={},c={},u="533e5eea3d1b3eb5d9616d2723cf4b6b",l=(L.OWM.clouds({showLegend:!0,opacity:.5,appId:u}),L.OWM.cloudsClassic({showLegend:!0,opacity:.5,appId:u}),L.OWM.precipitation({showLegend:!0,opacity:.5,appId:u}),L.OWM.precipitationClassic({showLegend:!0,opacity:.5,appId:u})),d=(L.OWM.rain({showLegend:!0,opacity:.5,appId:u}),L.OWM.rainClassic({showLegend:!0,opacity:.5,appId:u}),L.OWM.snow({showLegend:!0,opacity:.5,appId:u}),L.OWM.pressure({showLegend:!0,opacity:.5,appId:u})),p=(L.OWM.pressureContour({showLegend:!0,opacity:.5,appId:u}),L.OWM.temperature({showLegend:!0,opacity:.5,appId:u})),g=L.OWM.wind({showLegend:!0,opacity:.5,appId:u}),m=L.OWM.current({intervall:0,lang:"en",appId:u,temperatureUnit:"F"}),h=0;h<e.json.length;h++){var v=e.json[h];if(1==v.MapLayerTypeID&&(v.EventID==i||null==v.EventID))if(1==v.IsEsri){var f=L.esri.tiledMapLayer({url:v.ImageryURL,attribution:v.AttributionText});s[v.Name]=f}else o=new L.tileLayer(v.ImageryURL,{attribution:v.AttributionText,minZoom:v.MinZoomLevel,maxZoom:v.MaxZoomLevel}),s[v.Name]=o;2!=v.MapLayerTypeID||v.EventID!=i&&null!=v.EventID||(1==v.IsTSM?(n=new L.tileLayer(v.ImageryURL,{attribution:v.AttributionText,tms:!0,minZoom:v.MinZoomLevel,maxZoom:v.MaxZoomLevel}),c[v.Name]=n):(n=new L.tileLayer(v.ImageryURL,{attribution:v.AttributionText,minZoom:v.MinZoomLevel,maxZoom:v.MaxZoomLevel}),c[v.Name]=n))}c.Precipitation=l,c.Pressure=d,c.Temp=p,c.Wind=g,c["City Data"]=m;var y=new L.map("map",{layers:[o],maxBounds:[[-90,-180],[90,180]]}).setView(r,a);L.control.scale().addTo(y),y.attributionControl.setPrefix(""),L.control.layers(s,c,null,{collapsed:!0}).addTo(y),y.addControl(new L.Control.Search({url:"http://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],circleLocation:!1,markerLocation:!1,autoType:!1,autoCollapse:!0,minLength:2,zoom:13})),t.initMap&&t.initMap(y)})}}}]),angular.module("helpNow").factory("Account",function(e){return e("api/account/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("api_interceptor",function(e,t){return{request:function(t){return t.headers=t.headers||{},e.get("cookie.helpnowmap.org")&&(t.headers.Authorization="JWT "+e.get("cookie.helpnowmap.org")),t},responseError:function(e){return(401===e.status||403===e.status)&&(alert("Unauthorized.  "),t.path("/login")),e}}}),angular.module("helpNow").config(["$httpProvider",function(e){e.interceptors.push("api_interceptor")}]),angular.module("helpNow").factory("DemoService",["$q",function(e){var t=new Worker("doWork.js"),o=e.defer();return t.addEventListener("message",function(e){console.log("Worker said: ",e.data),o.resolve(e.data)},!1),{doWork:function(n){return o=e.defer(),t.postMessage(n),o.promise}}}]),angular.module("helpNow").factory("Event",function(e){return e("api/event/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("EventLocation",function(e){return e("api/eventlocation/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("Invitation",function(e){return e("api/inviterequest/:inviteid",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("MapLayer",function(e){return e("api/maplayer/",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("Organization",function(e){return e("/api/organization/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("Regulation",function(e){return e("api/organizationregulation/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("ResourceLocation",function(e){return e("api/resourcelocation/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("ResourceLocationInventory",function(e){return e("api/resourcelocationinventory/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("ResourceLocationTransport",function(e){return e("api/resourcelocationtransport/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("ResourceLocationType",function(e){return e("api/resourcelocationtype/:id",null,{update:{method:"PUT"}})}),angular.module("helpNow").factory("ResourceRequest",function(e){return e("api/resourcerequest/:id",null,{update:{method:"PUT"}})});